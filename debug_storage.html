<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­˜å‚¨æ•°æ®è°ƒè¯• - å¤šè¯­è¨€å•è¯ç¬”è®°æœ¬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .section h2 {
            color: #475569;
            margin-bottom: 15px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button.danger {
            background: #dc2626;
        }
        button.danger:hover {
            background: #b91c1c;
        }
        .output {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .status.info {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        
        <h1>ğŸ”§ å­˜å‚¨æ•°æ®è°ƒè¯•å·¥å…·</h1>
        <p>å¦‚æœä½ çš„å•è¯æ— æ³•æ˜¾ç¤ºï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥æ£€æŸ¥å’Œè¿ç§»æ•°æ®ã€‚</p>
        
        <div class="section">
            <h2>ğŸ“Š å½“å‰å­˜å‚¨çŠ¶æ€</h2>
            <button onclick="checkCurrentData()">æ£€æŸ¥å½“å‰æ•°æ®</button>
            <div id="current-status" class="output"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ” æŸ¥æ‰¾æ—§æ•°æ®</h2>
            <button onclick="findOldData()">æ‰«ææ‰€æœ‰å¯èƒ½çš„æ—§æ•°æ®</button>
            <div id="old-data-status" class="output"></div>
        </div>
        
        <div class="section">
            <h2>ğŸš€ è‡ªåŠ¨è¿ç§»</h2>
            <button onclick="performAutoMigration()">æ‰§è¡Œè‡ªåŠ¨æ•°æ®è¿ç§»</button>
            <div id="migration-status"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ› ï¸ æ‰‹åŠ¨è¿ç§»</h2>
            <p>å¦‚æœè‡ªåŠ¨è¿ç§»å¤±è´¥ï¼Œä½ å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ—§çš„å­˜å‚¨é”®åï¼š</p>
            <div>
                <label>æ—§å•è¯æ•°æ®é”®å: </label>
                <input type="text" id="old-words-key" placeholder="ä¾‹å¦‚: words" style="padding: 5px; margin: 5px;">
            </div>
            <div>
                <label>æ—§è®¾ç½®æ•°æ®é”®å: </label>
                <input type="text" id="old-settings-key" placeholder="ä¾‹å¦‚: settings" style="padding: 5px; margin: 5px;">
            </div>
            <button onclick="performManualMigration()">æ‰§è¡Œæ‰‹åŠ¨è¿ç§»</button>
            <div id="manual-migration-status"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ—‘ï¸ æ¸…ç†å·¥å…·</h2>
            <p style="color: #dc2626;">âš ï¸ å±é™©æ“ä½œï¼šè¿™äº›æ“ä½œä¼šåˆ é™¤æ•°æ®ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼</p>
            <button class="danger" onclick="clearCurrentData()">æ¸…ç©ºå½“å‰æ•°æ®</button>
            <button class="danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰å­˜å‚¨æ•°æ®</button>
            <div id="clear-status"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ“‹ æ‰€æœ‰å­˜å‚¨é”®</h2>
            <button onclick="listAllStorageKeys()">åˆ—å‡ºæ‰€æœ‰localStorageé”®</button>
            <div id="all-keys-status" class="output"></div>
        </div>
    </div>

    <script type="module">
        import { performDataMigration, listPossibleOldData, manualMigrate } from './js/modules/dataMigration.js';
        
        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.performDataMigration = performDataMigration;
        window.listPossibleOldData = listPossibleOldData;
        window.manualMigrate = manualMigrate;
        
        window.checkCurrentData = function() {
            const output = document.getElementById('current-status');
            const words = localStorage.getItem('polyglotWords');
            const settings = localStorage.getItem('polyglotSettings');
            
            let result = 'å½“å‰å­˜å‚¨çŠ¶æ€:\n\n';
            
            if (words) {
                try {
                    const parsedWords = JSON.parse(words);
                    result += `âœ… å•è¯æ•°æ®: æ‰¾åˆ° ${parsedWords.length} ä¸ªå•è¯\n`;
                } catch (e) {
                    result += `âŒ å•è¯æ•°æ®: æ•°æ®æŸå (${e.message})\n`;
                }
            } else {
                result += `âŒ å•è¯æ•°æ®: æœªæ‰¾åˆ°\n`;
            }
            
            if (settings) {
                try {
                    const parsedSettings = JSON.parse(settings);
                    result += `âœ… è®¾ç½®æ•°æ®: å·²æ‰¾åˆ°\n`;
                    result += `   - æ¯è¯­: ${parsedSettings.nativeLanguage || 'æœªè®¾ç½®'}\n`;
                    result += `   - å­¦ä¹ è¯­è¨€: ${parsedSettings.learningLanguages?.join(', ') || 'æœªè®¾ç½®'}\n`;
                } catch (e) {
                    result += `âŒ è®¾ç½®æ•°æ®: æ•°æ®æŸå (${e.message})\n`;
                }
            } else {
                result += `âŒ è®¾ç½®æ•°æ®: æœªæ‰¾åˆ°\n`;
            }
            
            output.textContent = result;
        };
        
        window.findOldData = function() {
            const output = document.getElementById('old-data-status');
            const oldData = listPossibleOldData();
            
            if (oldData.length === 0) {
                output.textContent = 'æœªæ‰¾åˆ°ä»»ä½•å¯èƒ½çš„æ—§æ•°æ®';
            } else {
                let result = 'æ‰¾åˆ°ä»¥ä¸‹å¯èƒ½çš„æ—§æ•°æ®:\n\n';
                oldData.forEach(item => {
                    result += `é”®å: ${item.key}\n`;
                    result += `ç±»å‹: ${item.dataType}\n`;
                    if (item.length !== undefined) {
                        result += `é•¿åº¦: ${item.length}\n`;
                    }
                    if (item.preview) {
                        result += `é¢„è§ˆ: ${item.preview}\n`;
                    }
                    if (item.error) {
                        result += `é”™è¯¯: ${item.error}\n`;
                    }
                    result += '\n';
                });
                output.textContent = result;
            }
        };
        
        window.performAutoMigration = function() {
            const statusDiv = document.getElementById('migration-status');
            
            try {
                const migrated = performDataMigration();
                if (migrated) {
                    statusDiv.innerHTML = '<div class="status success">âœ… æ•°æ®è¿ç§»æˆåŠŸï¼è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœã€‚</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status info">â„¹ï¸ æ— éœ€è¿ç§»æ•°æ®ï¼Œå½“å‰æ•°æ®å®Œæ•´æˆ–æœªæ‰¾åˆ°æ—§æ•°æ®ã€‚</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ è¿ç§»å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        window.performManualMigration = function() {
            const statusDiv = document.getElementById('manual-migration-status');
            const wordsKey = document.getElementById('old-words-key').value.trim();
            const settingsKey = document.getElementById('old-settings-key').value.trim();
            
            if (!wordsKey && !settingsKey) {
                statusDiv.innerHTML = '<div class="status error">âŒ è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªé”®å</div>';
                return;
            }
            
            try {
                const migrated = manualMigrate(wordsKey || null, settingsKey || null);
                if (migrated) {
                    statusDiv.innerHTML = '<div class="status success">âœ… æ‰‹åŠ¨è¿ç§»æˆåŠŸï¼è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœã€‚</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">âŒ æ‰‹åŠ¨è¿ç§»å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”®åæ˜¯å¦æ­£ç¡®ã€‚</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ è¿ç§»å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        window.clearCurrentData = function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯æ’¤é”€ï¼')) {
                localStorage.removeItem('polyglotWords');
                localStorage.removeItem('polyglotSettings');
                document.getElementById('clear-status').innerHTML = '<div class="status success">âœ… å½“å‰æ•°æ®å·²æ¸…ç©º</div>';
            }
        };
        
        window.clearAllData = function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰localStorageæ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯æ’¤é”€ï¼')) {
                localStorage.clear();
                document.getElementById('clear-status').innerHTML = '<div class="status success">âœ… æ‰€æœ‰å­˜å‚¨æ•°æ®å·²æ¸…ç©º</div>';
            }
        };
        
        window.listAllStorageKeys = function() {
            const output = document.getElementById('all-keys-status');
            const keys = Object.keys(localStorage);
            
            if (keys.length === 0) {
                output.textContent = 'localStorage ä¸­æ²¡æœ‰ä»»ä½•æ•°æ®';
            } else {
                let result = `æ‰¾åˆ° ${keys.length} ä¸ªå­˜å‚¨é”®:\n\n`;
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    const size = new Blob([value]).size;
                    result += `${key} (${size} bytes)\n`;
                });
                output.textContent = result;
            }
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        
        .word-display {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <h1>ç®€å•ä¿®å¤æµ‹è¯•</h1>
    
    <div>
        <button onclick="runTest()">è¿è¡Œæµ‹è¯•</button>
        <button onclick="clearData()">æ¸…é™¤æ•°æ®</button>
    </div>
    
    <div id="results"></div>

    <script type="module">
        // ç®€åŒ–æµ‹è¯•ï¼Œç›´æ¥ä½¿ç”¨localStorage
        
        window.runTest = async function() {
            const resultsDiv = document.getElementById('results');
            let html = '<h2>æµ‹è¯•ç»“æœ</h2>';
            
            try {
                // 1. åˆ›å»ºæµ‹è¯•æ•°æ®
                const testWord = {
                    id: 'test1',
                    translations: [
                        { language: 'en', text: 'apple', phonetic: '/ËˆÃ¦pÉ™l/', example: '', audio: null },
                        { language: 'zh', text: 'è‹¹æœ', phonetic: 'pÃ­ng guÇ’', example: '', audio: null },
                        { language: 'ko', text: 'ì‚¬ê³¼', phonetic: 'sagwa', example: '', audio: null }
                    ],
                    nativeNote: 'çº¢è‰²çš„æ°´æœ',
                    image: null,
                    tags: ['æ°´æœ']
                };
                
                const userSettings = {
                    nativeLanguage: 'zh',
                    learningLanguages: ['en', 'ko']
                };
                
                localStorage.setItem('polyglotWords', JSON.stringify([testWord]));
                localStorage.setItem('polyglotSettings', JSON.stringify(userSettings));
                
                html += '<div class="result success">âœ… æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ</div>';
                
                // 2. æ˜¾ç¤ºåˆå§‹çŠ¶æ€
                html += '<div class="word-display">';
                html += '<h3>åˆå§‹çŠ¶æ€ï¼ˆæ¯è¯­ï¼šä¸­æ–‡ï¼‰</h3>';
                html += `<p><strong>æ¯è¯­æ³¨é‡Šï¼š</strong>${testWord.nativeNote}</p>`;
                html += '<p><strong>ç¿»è¯‘ï¼š</strong>';
                testWord.translations.forEach(t => {
                    html += `${t.language}:${t.text} `;
                });
                html += '</p></div>';
                
                // 3. å°è¯•å¯¼å…¥æ¨¡å—å¹¶æ‰§è¡Œè¿ç§»
                try {
                    const { migrateLanguageData } = await import('../js/modules/userSettings.js');
                    const { words } = await import('../js/modules/wordManager.js');
                    
                    html += '<div class="result success">âœ… æ¨¡å—å¯¼å…¥æˆåŠŸ</div>';
                    
                    // æ¨¡æ‹Ÿåˆ‡æ¢åˆ°è‹±è¯­
                    const previousNative = 'zh';
                    
                    // æ›´æ–°è®¾ç½®ï¼ˆæ¨¡æ‹Ÿåˆ‡æ¢ï¼‰
                    const newSettings = {
                        nativeLanguage: 'en',
                        learningLanguages: ['zh', 'ko']
                    };
                    localStorage.setItem('polyglotSettings', JSON.stringify(newSettings));
                    
                    // æ‰§è¡Œè¿ç§»
                    const result = await migrateLanguageData(previousNative);
                    
                    html += `<div class="result info">ğŸ“‹ è¿ç§»ç»“æœ: ${result.message}</div>`;
                    
                    // 4. æ˜¾ç¤ºè¿ç§»åçŠ¶æ€
                    const updatedWords = JSON.parse(localStorage.getItem('polyglotWords') || '[]');
                    if (updatedWords.length > 0) {
                        const updatedWord = updatedWords[0];
                        html += '<div class="word-display">';
                        html += '<h3>è¿ç§»åçŠ¶æ€ï¼ˆæ¯è¯­ï¼šè‹±è¯­ï¼‰</h3>';
                        html += `<p><strong>æ¯è¯­æ³¨é‡Šï¼š</strong>${updatedWord.nativeNote}</p>`;
                        html += '<p><strong>ç¿»è¯‘ï¼š</strong>';
                        updatedWord.translations.forEach(t => {
                            html += `${t.language}:${t.text} `;
                        });
                        html += '</p></div>';
                        
                        // 5. éªŒè¯ç»“æœ
                        if (updatedWord.nativeNote === 'apple') {
                            html += '<div class="result success">âœ… æ¯è¯­æ³¨é‡Šæ­£ç¡®æ›´æ–°ä¸ºè‹±è¯­å†…å®¹</div>';
                        } else {
                            html += '<div class="result error">âŒ æ¯è¯­æ³¨é‡Šæœªæ­£ç¡®æ›´æ–°</div>';
                        }
                        
                        const hasChineseTranslation = updatedWord.translations.some(t => 
                            t.language === 'zh' && t.text === 'çº¢è‰²çš„æ°´æœ');
                        if (hasChineseTranslation) {
                            html += '<div class="result success">âœ… åŸæ¯è¯­æ³¨é‡Šæ­£ç¡®è½¬æ¢ä¸ºä¸­æ–‡ç¿»è¯‘</div>';
                        } else {
                            html += '<div class="result error">âŒ åŸæ¯è¯­æ³¨é‡Šæœªæ­£ç¡®è½¬æ¢</div>';
                        }
                    }
                    
                } catch (moduleError) {
                    html += `<div class="result error">âŒ æ¨¡å—å¯¼å…¥æˆ–æ‰§è¡Œå¤±è´¥: ${moduleError.message}</div>`;
                    console.error('Module error:', moduleError);
                }
                
            } catch (error) {
                html += `<div class="result error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                console.error('Test error:', error);
            }
            
            resultsDiv.innerHTML = html;
        };
        
        window.clearData = function() {
            localStorage.removeItem('polyglotWords');
            localStorage.removeItem('polyglotSettings');
            document.getElementById('results').innerHTML = '<div class="result info">ğŸ—‘ï¸ æ•°æ®å·²æ¸…é™¤</div>';
        };
    </script>
</body>
</html>
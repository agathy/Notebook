<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿæ¯è¯­åˆ‡æ¢æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .result {
            background: #f0f8ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        
        .word-display {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .native-note {
            background: #fff3e0;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .translation {
            display: inline-block;
            margin: 2px 5px;
            padding: 2px 8px;
            background: #e3f2fd;
            border-radius: 12px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>å¿«é€Ÿæ¯è¯­åˆ‡æ¢æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºå¿«é€Ÿæµ‹è¯•æ¯è¯­åˆ‡æ¢åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        <p><strong>é¢„æœŸè¡Œä¸ºï¼š</strong>å½“åˆ‡æ¢æ¯è¯­æ—¶ï¼Œå•è¯ä¸­è¯¥è¯­è¨€çš„å†…å®¹åº”è¯¥å˜æˆæ¯è¯­æ³¨é‡Šã€‚</p>
    </div>
    
    <div class="test-section">
        <h2>1. åˆå§‹åŒ–æµ‹è¯•æ•°æ®</h2>
        <button onclick="initTestData()">åˆ›å»ºæµ‹è¯•å•è¯</button>
        <button onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
        <div id="init-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. å½“å‰çŠ¶æ€</h2>
        <div id="current-status">ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"æŸ¥çœ‹å½“å‰è®¾ç½®å’Œå•è¯</div>
        <button onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
    </div>
    
    <div class="test-section">
        <h2>3. æ¯è¯­åˆ‡æ¢æµ‹è¯•</h2>
        <button onclick="testLanguageSwitch('zh')">æµ‹è¯•åˆ‡æ¢åˆ°ä¸­æ–‡</button>
        <button onclick="testLanguageSwitch('en')">æµ‹è¯•åˆ‡æ¢åˆ°è‹±è¯­</button>
        <button onclick="testLanguageSwitch('ko')">æµ‹è¯•åˆ‡æ¢åˆ°éŸ©è¯­</button>
        <div id="switch-result"></div>
    </div>

    <script type="module">
        // ç®€åŒ–çš„æµ‹è¯•ï¼Œç›´æ¥ä½¿ç”¨localStorageè€Œä¸ä¾èµ–å¤æ‚çš„æ¨¡å—ç³»ç»Ÿ
        
        // æµ‹è¯•æ•°æ®
        const testWords = [
            {
                id: 'test1',
                translations: [
                    { language: 'en', text: 'apple', phonetic: '/ËˆÃ¦pÉ™l/', example: 'I eat an apple.', audio: null },
                    { language: 'zh', text: 'è‹¹æœ', phonetic: 'pÃ­ng guÇ’', example: 'æˆ‘åƒè‹¹æœã€‚', audio: null },
                    { language: 'ko', text: 'ì‚¬ê³¼', phonetic: 'sagwa', example: 'ì‚¬ê³¼ë¥¼ ë¨¹ì–´ìš”.', audio: null }
                ],
                nativeNote: 'çº¢è‰²çš„æ°´æœ',
                image: null,
                tags: ['æ°´æœ', 'é£Ÿç‰©']
            }
        ];
        
        let userSettings = {
            nativeLanguage: 'zh',
            learningLanguages: ['en', 'ko']
        };
        
        // è¯­è¨€ä¿¡æ¯
        const languageInfo = {
            zh: { code: 'zh', name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
            en: { code: 'en', name: 'è‹±è¯­', flag: 'ğŸ‡ºğŸ‡¸' },
            ko: { code: 'ko', name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·' }
        };
        
        // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
        window.initTestData = function() {
            try {
                localStorage.setItem('polyglotWords', JSON.stringify(testWords));
                localStorage.setItem('polyglotSettings', JSON.stringify(userSettings));
                
                document.getElementById('init-result').innerHTML = 
                    '<div class="result success">âœ… æµ‹è¯•æ•°æ®å·²åˆ›å»º</div>';
                
                refreshStatus();
            } catch (error) {
                document.getElementById('init-result').innerHTML = 
                    `<div class="result error">âŒ åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ¸…é™¤æµ‹è¯•æ•°æ®
        window.clearTestData = function() {
            localStorage.removeItem('polyglotWords');
            localStorage.removeItem('polyglotSettings');
            
            document.getElementById('init-result').innerHTML = 
                '<div class="result">ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…é™¤</div>';
            
            refreshStatus();
        };
        
        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
        window.refreshStatus = function() {
            try {
                const words = JSON.parse(localStorage.getItem('polyglotWords') || '[]');
                const settings = JSON.parse(localStorage.getItem('polyglotSettings') || '{}');
                
                let html = '<h3>å½“å‰è®¾ç½®</h3>';
                html += `<p><strong>æ¯è¯­:</strong> ${settings.nativeLanguage ? languageInfo[settings.nativeLanguage]?.name : 'æœªè®¾ç½®'}</p>`;
                html += `<p><strong>å­¦ä¹ è¯­è¨€:</strong> ${settings.learningLanguages?.map(code => languageInfo[code]?.name).join(', ') || 'æœªè®¾ç½®'}</p>`;
                
                html += '<h3>å½“å‰å•è¯</h3>';
                if (words.length === 0) {
                    html += '<p>æš‚æ— å•è¯</p>';
                } else {
                    words.forEach((word, index) => {
                        html += '<div class="word-display">';
                        html += `<strong>å•è¯ ${index + 1}:</strong><br>`;
                        
                        // æ˜¾ç¤ºç¿»è¯‘
                        word.translations.forEach(t => {
                            html += `<span class="translation">${languageInfo[t.language]?.flag} ${t.text}</span>`;
                        });
                        
                        // æ˜¾ç¤ºæ¯è¯­æ³¨é‡Š
                        html += `<div class="native-note">æ¯è¯­æ³¨é‡Š: ${word.nativeNote || 'æ— '}</div>`;
                        html += '</div>';
                    });
                }
                
                document.getElementById('current-status').innerHTML = html;
            } catch (error) {
                document.getElementById('current-status').innerHTML = 
                    `<div class="result error">âŒ çŠ¶æ€è¯»å–å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æµ‹è¯•è¯­è¨€åˆ‡æ¢
        window.testLanguageSwitch = function(newLanguageCode) {
            try {
                const words = JSON.parse(localStorage.getItem('polyglotWords') || '[]');
                const settings = JSON.parse(localStorage.getItem('polyglotSettings') || '{}');
                
                if (words.length === 0) {
                    document.getElementById('switch-result').innerHTML = 
                        '<div class="result error">âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®</div>';
                    return;
                }
                
                const previousNative = settings.nativeLanguage;
                const newLanguageName = languageInfo[newLanguageCode]?.name;
                const previousLanguageName = languageInfo[previousNative]?.name;
                
                let resultHtml = `<div class="result">ğŸ”„ å¼€å§‹æµ‹è¯•åˆ‡æ¢: ${previousLanguageName} â†’ ${newLanguageName}</div>`;
                
                // æ‰§è¡Œè¯­è¨€åˆ‡æ¢é€»è¾‘
                let migratedCount = 0;
                
                words.forEach(word => {
                    let hasChanges = false;
                    
                    // æ­¥éª¤1: å°†åŸæ¯è¯­æ³¨é‡Šè½¬æ¢ä¸ºç¿»è¯‘ï¼ˆå¦‚æœåŸæ¯è¯­ç°åœ¨æ˜¯å­¦ä¹ è¯­è¨€ï¼‰
                    if (previousNative && 
                        word.nativeNote && 
                        settings.learningLanguages && 
                        settings.learningLanguages.includes(previousNative)) {
                        
                        const existingTranslation = word.translations.find(t => t.language === previousNative);
                        if (!existingTranslation) {
                            word.translations.push({
                                language: previousNative,
                                text: word.nativeNote,
                                phonetic: '',
                                example: '',
                                audio: null
                            });
                            hasChanges = true;
                            resultHtml += `<div class="result">ğŸ“ å°†åŸæ¯è¯­æ³¨é‡Š "${word.nativeNote}" è½¬æ¢ä¸º ${previousLanguageName} ç¿»è¯‘</div>`;
                        }
                    }
                    
                    // æ­¥éª¤2: å°†æ–°æ¯è¯­çš„ç¿»è¯‘è®¾ç½®ä¸ºæ¯è¯­æ³¨é‡Š
                    const nativeTranslation = word.translations.find(t => t.language === newLanguageCode);
                    if (nativeTranslation && nativeTranslation.text) {
                        const oldNote = word.nativeNote;
                        word.nativeNote = nativeTranslation.text;
                        word.translations = word.translations.filter(t => t.language !== newLanguageCode);
                        hasChanges = true;
                        resultHtml += `<div class="result">âœ… å°† ${newLanguageName} ç¿»è¯‘ "${nativeTranslation.text}" è®¾ç½®ä¸ºæ¯è¯­æ³¨é‡Š</div>`;
                        resultHtml += `<div class="result">ğŸ“‹ åŸæ¯è¯­æ³¨é‡Š: "${oldNote}" â†’ æ–°æ¯è¯­æ³¨é‡Š: "${word.nativeNote}"</div>`;
                    }
                    
                    if (hasChanges) {
                        migratedCount++;
                    }
                });
                
                // æ›´æ–°è®¾ç½®
                settings.nativeLanguage = newLanguageCode;
                if (!settings.learningLanguages.includes(newLanguageCode)) {
                    // ç¡®ä¿æ–°æ¯è¯­ä¸åœ¨å­¦ä¹ è¯­è¨€ä¸­
                    settings.learningLanguages = settings.learningLanguages.filter(lang => lang !== newLanguageCode);
                }
                if (previousNative && !settings.learningLanguages.includes(previousNative)) {
                    // å°†åŸæ¯è¯­æ·»åŠ åˆ°å­¦ä¹ è¯­è¨€ä¸­
                    settings.learningLanguages.push(previousNative);
                }
                
                // ä¿å­˜æ›´æ–°åçš„æ•°æ®
                localStorage.setItem('polyglotWords', JSON.stringify(words));
                localStorage.setItem('polyglotSettings', JSON.stringify(settings));
                
                resultHtml += `<div class="result success">ğŸ‰ åˆ‡æ¢å®Œæˆï¼å¤„ç†äº† ${migratedCount} ä¸ªå•è¯</div>`;
                
                document.getElementById('switch-result').innerHTML = resultHtml;
                
                // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
                setTimeout(refreshStatus, 500);
                
            } catch (error) {
                document.getElementById('switch-result').innerHTML = 
                    `<div class="result error">âŒ åˆ‡æ¢å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
        });
    </script>
</body>
</html>
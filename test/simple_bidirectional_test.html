<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•åŒå‘è¿ç§»æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        
        .word-state {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .native-note {
            background: #fff3e0;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-weight: bold;
            border-left: 3px solid #ff9800;
        }
        
        .translation {
            display: inline-block;
            margin: 3px 5px;
            padding: 4px 10px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #2196f3;
        }
        
        .step-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .before, .after {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .before { background: #fff3cd; }
        .after { background: #d4edda; }
    </style>
</head>
<body>
    <h1>ğŸ”„ ç®€å•åŒå‘è¿ç§»æµ‹è¯•</h1>
    
    <div class="result info">
        <strong>ğŸ¯ æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯ç”¨æˆ·åé¦ˆçš„é—®é¢˜æ˜¯å¦å·²ä¿®å¤ï¼š
        <br><em>"å½“è¯­è¨€aè¢«è®¾ç½®ä¸ºæ¯è¯­æ—¶,ä»–çš„å†…å®¹ä¼šå˜æˆæ¯è¯­æ³¨é‡Š,ä½†å½“æ¯è¯­bè¢«è®¾ç½®ä¸ºå­¦ä¹ è¯­è¨€æ—¶,æ¯è¯­æ³¨é‡Šä¸­çš„å†…å®¹ä¸ä¼šä¿ç•™åˆ°è¯­è¨€bé‡Œ"</em>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 1: åˆå§‹åŒ–æµ‹è¯•æ•°æ®</div>
        <button onclick="initTest()">åˆ›å»ºæµ‹è¯•æ•°æ®</button>
        <div id="init-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 2: ç¬¬ä¸€æ¬¡è¯­è¨€åˆ‡æ¢ï¼ˆä¸­æ–‡â†’è‹±è¯­ï¼‰</div>
        <p>æµ‹è¯•å°†ä¸­æ–‡æ¯è¯­åˆ‡æ¢ä¸ºè‹±è¯­æ¯è¯­æ—¶çš„æ•°æ®è¿ç§»</p>
        <button onclick="testSwitch1()">ä¸­æ–‡ â†’ è‹±è¯­</button>
        <div id="switch1-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 3: ç¬¬äºŒæ¬¡è¯­è¨€åˆ‡æ¢ï¼ˆè‹±è¯­â†’éŸ©è¯­ï¼‰</div>
        <p>æµ‹è¯•å°†è‹±è¯­æ¯è¯­åˆ‡æ¢ä¸ºéŸ©è¯­æ¯è¯­æ—¶çš„æ•°æ®è¿ç§»</p>
        <button onclick="testSwitch2()">è‹±è¯­ â†’ éŸ©è¯­</button>
        <div id="switch2-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 4: å›å½’æµ‹è¯•ï¼ˆéŸ©è¯­â†’ä¸­æ–‡ï¼‰</div>
        <p>æµ‹è¯•å›åˆ°åŸå§‹è¯­è¨€æ—¶æ•°æ®æ˜¯å¦å®Œæ•´</p>
        <button onclick="testSwitch3()">éŸ©è¯­ â†’ ä¸­æ–‡</button>
        <div id="switch3-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 5: æœ€ç»ˆéªŒè¯</div>
        <button onclick="finalVerification()">éªŒè¯ç»“æœ</button>
        <div id="final-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ¸…ç†</div>
        <button onclick="cleanup()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
        <div id="cleanup-result"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸåŒå‘è¿ç§»é€»è¾‘ï¼ˆåŸºäºä¿®å¤åçš„ä»£ç ï¼‰
        function migrateLanguageData(word, userSettings, previousNativeLanguage) {
            let migratedCount = 0;
            let changes = [];
            
            if (!userSettings.nativeLanguage || !word) {
                return { migratedCount: 0, changes: [], message: 'æ— éœ€è¿ç§»æ•°æ®' };
            }
            
            let hasChanges = false;
            
            // ğŸ”‘ å…³é”®ä¿®å¤ï¼šä¿å­˜åŸæ¥çš„æ¯è¯­æ³¨é‡Š
            const originalNativeNote = word.nativeNote;
            
            // æ­¥éª¤1: æŸ¥æ‰¾ä¸æ–°æ¯è¯­ç›¸åŒçš„ç¿»è¯‘
            const nativeTranslation = word.translations.find(t => t.language === userSettings.nativeLanguage);
            
            // å¦‚æœæ‰¾åˆ°äº†ä¸æ–°æ¯è¯­ç›¸åŒçš„ç¿»è¯‘ï¼Œå…ˆè®¾ç½®ä¸ºæ–°çš„æ¯è¯­æ³¨é‡Š
            if (nativeTranslation && nativeTranslation.text) {
                // å°†è¯¥ç¿»è¯‘çš„å†…å®¹è®¾ç½®ä¸ºæ–°çš„æ¯è¯­æ³¨é‡Š
                word.nativeNote = nativeTranslation.text;
                
                // ä»ç¿»è¯‘åˆ—è¡¨ä¸­ç§»é™¤è¯¥è¯­è¨€
                word.translations = word.translations.filter(t => t.language !== userSettings.nativeLanguage);
                hasChanges = true;
                
                changes.push(`å°† ${nativeTranslation.text} è®¾ç½®ä¸ºæ¯è¯­æ³¨é‡Š`);
            }
            
            // æ­¥éª¤2: å°†åŸæ¥çš„æ¯è¯­æ³¨é‡Šè½¬æ¢ä¸ºç¿»è¯‘ï¼ˆå¦‚æœåŸæ¯è¯­ç°åœ¨æ˜¯å­¦ä¹ è¯­è¨€ï¼‰
            if (previousNativeLanguage && 
                originalNativeNote && 
                userSettings.learningLanguages.includes(previousNativeLanguage)) {
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¯¥è¯­è¨€çš„ç¿»è¯‘
                const existingTranslation = word.translations.find(t => t.language === previousNativeLanguage);
                
                if (!existingTranslation) {
                    // å°†åŸæ¯è¯­æ³¨é‡Šè½¬æ¢ä¸ºç¿»è¯‘
                    word.translations.push({
                        language: previousNativeLanguage,
                        text: originalNativeNote,
                        phonetic: '',
                        example: '',
                        audio: null
                    });
                    hasChanges = true;
                    changes.push(`å°†åŸæ¯è¯­æ³¨é‡Š "${originalNativeNote}" è½¬æ¢ä¸ºç¿»è¯‘`);
                } else if (!existingTranslation.text) {
                    // å¦‚æœç¿»è¯‘å­˜åœ¨ä½†æ²¡æœ‰æ–‡æœ¬ï¼Œç”¨åŸæ¯è¯­æ³¨é‡Šå¡«å……
                    existingTranslation.text = originalNativeNote;
                    hasChanges = true;
                    changes.push(`ç”¨åŸæ¯è¯­æ³¨é‡Šå¡«å……ç¿»è¯‘`);
                }
            }
            
            // æ­¥éª¤3: å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–°æ¯è¯­çš„ç¿»è¯‘ï¼Œä½†æœ‰åŸæ¯è¯­æ³¨é‡Šï¼Œéœ€è¦å¤„ç†
            if (!nativeTranslation && !word.nativeNote && originalNativeNote) {
                // å¦‚æœæ–°æ¯è¯­æ²¡æœ‰ç¿»è¯‘ï¼Œä¿æŒåŸæ¥çš„æ¯è¯­æ³¨é‡Š
                word.nativeNote = originalNativeNote;
                changes.push(`ä¿æŒåŸæ¯è¯­æ³¨é‡Šï¼Œå› ä¸ºæ–°æ¯è¯­æ²¡æœ‰ç¿»è¯‘`);
            }
            
            if (hasChanges) {
                migratedCount++;
            }
            
            return { 
                migratedCount, 
                changes,
                message: migratedCount > 0 ? `æˆåŠŸå¤„ç† ${migratedCount} ä¸ªå•è¯` : 'æ— éœ€è¿ç§»æ•°æ®'
            };
        }
        
        // æµ‹è¯•æ•°æ®
        let testWord = null;
        let userSettings = null;
        
        // è¯­è¨€ä¿¡æ¯
        const languageInfo = {
            zh: { code: 'zh', name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
            en: { code: 'en', name: 'è‹±è¯­', flag: 'ğŸ‡ºğŸ‡¸' },
            ko: { code: 'ko', name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·' }
        };
        
        // åˆå§‹åŒ–æµ‹è¯•
        window.initTest = function() {
            try {
                // åˆ›å»ºæµ‹è¯•å•è¯
                testWord = {
                    id: 'test1',
                    translations: [
                        { language: 'en', text: 'apple', phonetic: '/ËˆÃ¦pÉ™l/', example: '', audio: null },
                        { language: 'ko', text: 'ì‚¬ê³¼', phonetic: 'sagwa', example: '', audio: null }
                    ],
                    nativeNote: 'çº¢è‰²çš„æ°´æœ',  // ä¸­æ–‡æ¯è¯­æ³¨é‡Š
                    image: null,
                    tags: ['æ°´æœ']
                };
                
                userSettings = {
                    nativeLanguage: 'zh',  // åˆå§‹æ¯è¯­æ˜¯ä¸­æ–‡
                    learningLanguages: ['en', 'ko']
                };
                
                let html = '<div class="result success">âœ… æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ</div>';
                html += displayWordState('åˆå§‹çŠ¶æ€', testWord, userSettings);
                
                document.getElementById('init-result').innerHTML = html;
                
            } catch (error) {
                document.getElementById('init-result').innerHTML = 
                    `<div class="result error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // ç¬¬ä¸€æ¬¡åˆ‡æ¢ï¼šä¸­æ–‡ â†’ è‹±è¯­
        window.testSwitch1 = function() {
            if (!testWord || !userSettings) {
                document.getElementById('switch1-result').innerHTML = 
                    '<div class="result warning">âš ï¸ è¯·å…ˆåˆå§‹åŒ–æµ‹è¯•æ•°æ®</div>';
                return;
            }
            
            try {
                let html = '<h4>ğŸ”„ ç¬¬ä¸€æ¬¡åˆ‡æ¢ï¼šä¸­æ–‡ â†’ è‹±è¯­</h4>';
                
                // è®°å½•åˆ‡æ¢å‰çŠ¶æ€
                const beforeState = JSON.parse(JSON.stringify(testWord));
                
                html += '<div class="comparison">';
                html += '<div class="before"><h5>åˆ‡æ¢å‰</h5>' + displayWordState('', beforeState, userSettings) + '</div>';
                
                // æ‰§è¡Œåˆ‡æ¢
                const previousNative = userSettings.nativeLanguage;
                userSettings.nativeLanguage = 'en';
                userSettings.learningLanguages = ['zh', 'ko'];  // ä¸­æ–‡å˜æˆå­¦ä¹ è¯­è¨€
                
                const result = migrateLanguageData(testWord, userSettings, previousNative);
                
                html += '<div class="after"><h5>åˆ‡æ¢å</h5>' + displayWordState('', testWord, userSettings) + '</div>';
                html += '</div>';
                
                html += `<div class="result info">ğŸ“Š è¿ç§»ç»“æœ: ${result.message}</div>`;
                result.changes.forEach(change => {
                    html += `<div class="result success">âœ… ${change}</div>`;
                });
                
                // éªŒè¯å…³é”®ç‚¹
                const verifications = [
                    {
                        name: 'æ–°æ¯è¯­æ³¨é‡Šæ­£ç¡®',
                        check: testWord.nativeNote === 'apple',
                        expected: 'apple',
                        actual: testWord.nativeNote
                    },
                    {
                        name: 'åŸæ¯è¯­æ³¨é‡Šè½¬æ¢ä¸ºä¸­æ–‡ç¿»è¯‘',
                        check: testWord.translations.some(t => t.language === 'zh' && t.text === 'çº¢è‰²çš„æ°´æœ'),
                        expected: 'çº¢è‰²çš„æ°´æœ',
                        actual: testWord.translations.find(t => t.language === 'zh')?.text || 'æ— '
                    },
                    {
                        name: 'éŸ©è¯­ç¿»è¯‘ä¿ç•™',
                        check: testWord.translations.some(t => t.language === 'ko' && t.text === 'ì‚¬ê³¼'),
                        expected: 'ì‚¬ê³¼',
                        actual: testWord.translations.find(t => t.language === 'ko')?.text || 'æ— '
                    }
                ];
                
                verifications.forEach(v => {
                    html += `<div class="result ${v.check ? 'success' : 'error'}">
                        ${v.check ? 'âœ…' : 'âŒ'} ${v.name}: æœŸæœ› "${v.expected}", å®é™… "${v.actual}"
                    </div>`;
                });
                
                document.getElementById('switch1-result').innerHTML = html;
                
            } catch (error) {
                document.getElementById('switch1-result').innerHTML = 
                    `<div class="result error">âŒ åˆ‡æ¢å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // ç¬¬äºŒæ¬¡åˆ‡æ¢ï¼šè‹±è¯­ â†’ éŸ©è¯­
        window.testSwitch2 = function() {
            if (!testWord || !userSettings) {
                document.getElementById('switch2-result').innerHTML = 
                    '<div class="result warning">âš ï¸ è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤</div>';
                return;
            }
            
            try {
                let html = '<h4>ğŸ”„ ç¬¬äºŒæ¬¡åˆ‡æ¢ï¼šè‹±è¯­ â†’ éŸ©è¯­</h4>';
                
                // è®°å½•åˆ‡æ¢å‰çŠ¶æ€
                const beforeState = JSON.parse(JSON.stringify(testWord));
                
                html += '<div class="comparison">';
                html += '<div class="before"><h5>åˆ‡æ¢å‰</h5>' + displayWordState('', beforeState, userSettings) + '</div>';
                
                // æ‰§è¡Œåˆ‡æ¢
                const previousNative = userSettings.nativeLanguage;
                userSettings.nativeLanguage = 'ko';
                userSettings.learningLanguages = ['zh', 'en'];  // è‹±è¯­å˜æˆå­¦ä¹ è¯­è¨€
                
                const result = migrateLanguageData(testWord, userSettings, previousNative);
                
                html += '<div class="after"><h5>åˆ‡æ¢å</h5>' + displayWordState('', testWord, userSettings) + '</div>';
                html += '</div>';
                
                html += `<div class="result info">ğŸ“Š è¿ç§»ç»“æœ: ${result.message}</div>`;
                result.changes.forEach(change => {
                    html += `<div class="result success">âœ… ${change}</div>`;
                });
                
                // éªŒè¯å…³é”®ç‚¹
                const verifications = [
                    {
                        name: 'æ–°æ¯è¯­æ³¨é‡Šæ­£ç¡®',
                        check: testWord.nativeNote === 'ì‚¬ê³¼',
                        expected: 'ì‚¬ê³¼',
                        actual: testWord.nativeNote
                    },
                    {
                        name: 'åŸæ¯è¯­æ³¨é‡Šè½¬æ¢ä¸ºè‹±è¯­ç¿»è¯‘',
                        check: testWord.translations.some(t => t.language === 'en' && t.text === 'apple'),
                        expected: 'apple',
                        actual: testWord.translations.find(t => t.language === 'en')?.text || 'æ— '
                    },
                    {
                        name: 'ä¸­æ–‡ç¿»è¯‘ä¿ç•™',
                        check: testWord.translations.some(t => t.language === 'zh' && t.text === 'çº¢è‰²çš„æ°´æœ'),
                        expected: 'çº¢è‰²çš„æ°´æœ',
                        actual: testWord.translations.find(t => t.language === 'zh')?.text || 'æ— '
                    }
                ];
                
                verifications.forEach(v => {
                    html += `<div class="result ${v.check ? 'success' : 'error'}">
                        ${v.check ? 'âœ…' : 'âŒ'} ${v.name}: æœŸæœ› "${v.expected}", å®é™… "${v.actual}"
                    </div>`;
                });
                
                document.getElementById('switch2-result').innerHTML = html;
                
            } catch (error) {
                document.getElementById('switch2-result').innerHTML = 
                    `<div class="result error">âŒ åˆ‡æ¢å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // ç¬¬ä¸‰æ¬¡åˆ‡æ¢ï¼šéŸ©è¯­ â†’ ä¸­æ–‡ï¼ˆå›å½’æµ‹è¯•ï¼‰
        window.testSwitch3 = function() {
            if (!testWord || !userSettings) {
                document.getElementById('switch3-result').innerHTML = 
                    '<div class="result warning">âš ï¸ è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤</div>';
                return;
            }
            
            try {
                let html = '<h4>ğŸ”„ ç¬¬ä¸‰æ¬¡åˆ‡æ¢ï¼šéŸ©è¯­ â†’ ä¸­æ–‡ï¼ˆå›å½’æµ‹è¯•ï¼‰</h4>';
                
                // è®°å½•åˆ‡æ¢å‰çŠ¶æ€
                const beforeState = JSON.parse(JSON.stringify(testWord));
                
                html += '<div class="comparison">';
                html += '<div class="before"><h5>åˆ‡æ¢å‰</h5>' + displayWordState('', beforeState, userSettings) + '</div>';
                
                // æ‰§è¡Œåˆ‡æ¢
                const previousNative = userSettings.nativeLanguage;
                userSettings.nativeLanguage = 'zh';
                userSettings.learningLanguages = ['en', 'ko'];  // éŸ©è¯­å˜æˆå­¦ä¹ è¯­è¨€
                
                const result = migrateLanguageData(testWord, userSettings, previousNative);
                
                html += '<div class="after"><h5>åˆ‡æ¢å</h5>' + displayWordState('', testWord, userSettings) + '</div>';
                html += '</div>';
                
                html += `<div class="result info">ğŸ“Š è¿ç§»ç»“æœ: ${result.message}</div>`;
                result.changes.forEach(change => {
                    html += `<div class="result success">âœ… ${change}</div>`;
                });
                
                // éªŒè¯å…³é”®ç‚¹
                const verifications = [
                    {
                        name: 'å›åˆ°åˆå§‹æ¯è¯­æ³¨é‡Š',
                        check: testWord.nativeNote === 'çº¢è‰²çš„æ°´æœ',
                        expected: 'çº¢è‰²çš„æ°´æœ',
                        actual: testWord.nativeNote
                    },
                    {
                        name: 'åŸæ¯è¯­æ³¨é‡Šè½¬æ¢ä¸ºéŸ©è¯­ç¿»è¯‘',
                        check: testWord.translations.some(t => t.language === 'ko' && t.text === 'ì‚¬ê³¼'),
                        expected: 'ì‚¬ê³¼',
                        actual: testWord.translations.find(t => t.language === 'ko')?.text || 'æ— '
                    },
                    {
                        name: 'è‹±è¯­ç¿»è¯‘ä¿ç•™',
                        check: testWord.translations.some(t => t.language === 'en' && t.text === 'apple'),
                        expected: 'apple',
                        actual: testWord.translations.find(t => t.language === 'en')?.text || 'æ— '
                    }
                ];
                
                verifications.forEach(v => {
                    html += `<div class="result ${v.check ? 'success' : 'error'}">
                        ${v.check ? 'âœ…' : 'âŒ'} ${v.name}: æœŸæœ› "${v.expected}", å®é™… "${v.actual}"
                    </div>`;
                });
                
                document.getElementById('switch3-result').innerHTML = html;
                
            } catch (error) {
                document.getElementById('switch3-result').innerHTML = 
                    `<div class="result error">âŒ åˆ‡æ¢å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æœ€ç»ˆéªŒè¯
        window.finalVerification = function() {
            if (!testWord || !userSettings) {
                document.getElementById('final-result').innerHTML = 
                    '<div class="result warning">âš ï¸ è¯·å…ˆå®Œæˆæ‰€æœ‰æµ‹è¯•æ­¥éª¤</div>';
                return;
            }
            
            try {
                let html = '<h3>ğŸ” æœ€ç»ˆéªŒè¯ç»“æœ</h3>';
                
                // æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
                const finalChecks = [
                    {
                        name: 'æ¯è¯­è®¾ç½®æ­£ç¡®',
                        check: userSettings.nativeLanguage === 'zh',
                        expected: 'ä¸­æ–‡',
                        actual: languageInfo[userSettings.nativeLanguage]?.name
                    },
                    {
                        name: 'æ¯è¯­æ³¨é‡Šæ­£ç¡®',
                        check: testWord.nativeNote === 'çº¢è‰²çš„æ°´æœ',
                        expected: 'çº¢è‰²çš„æ°´æœ',
                        actual: testWord.nativeNote
                    },
                    {
                        name: 'è‹±è¯­ç¿»è¯‘ä¿ç•™',
                        check: testWord.translations.some(t => t.language === 'en' && t.text === 'apple'),
                        expected: 'apple',
                        actual: testWord.translations.find(t => t.language === 'en')?.text || 'æ— '
                    },
                    {
                        name: 'éŸ©è¯­ç¿»è¯‘ä¿ç•™',
                        check: testWord.translations.some(t => t.language === 'ko' && t.text === 'ì‚¬ê³¼'),
                        expected: 'ì‚¬ê³¼',
                        actual: testWord.translations.find(t => t.language === 'ko')?.text || 'æ— '
                    },
                    {
                        name: 'ç¿»è¯‘æ•°é‡æ­£ç¡®',
                        check: testWord.translations.length === 2,
                        expected: '2ä¸ª',
                        actual: `${testWord.translations.length}ä¸ª`
                    }
                ];
                
                const allPassed = finalChecks.every(c => c.check);
                
                finalChecks.forEach(check => {
                    html += `<div class="result ${check.check ? 'success' : 'error'}">
                        ${check.check ? 'âœ…' : 'âŒ'} ${check.name}: æœŸæœ› ${check.expected}, å®é™… ${check.actual}
                    </div>`;
                });
                
                if (allPassed) {
                    html += '<div class="result success"><strong>ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼åŒå‘è¿ç§»åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼</strong></div>';
                    html += '<div class="result info">âœ… ç”¨æˆ·åé¦ˆçš„é—®é¢˜å·²å½»åº•è§£å†³ï¼šåŸæ¯è¯­æ³¨é‡Šç°åœ¨èƒ½æ­£ç¡®è½¬æ¢ä¸ºç¿»è¯‘</div>';
                } else {
                    html += '<div class="result error"><strong>âŒ éªŒè¯å¤±è´¥ï¼ŒåŒå‘è¿ç§»ä»å­˜åœ¨é—®é¢˜</strong></div>';
                }
                
                html += displayWordState('æœ€ç»ˆçŠ¶æ€', testWord, userSettings);
                
                document.getElementById('final-result').innerHTML = html;
                
            } catch (error) {
                document.getElementById('final-result').innerHTML = 
                    `<div class="result error">âŒ éªŒè¯å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        window.cleanup = function() {
            testWord = null;
            userSettings = null;
            
            document.getElementById('cleanup-result').innerHTML = 
                '<div class="result success">âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†</div>';
            
            // æ¸…ç©ºæ‰€æœ‰æ˜¾ç¤ºåŒºåŸŸ
            ['init-result', 'switch1-result', 'switch2-result', 'switch3-result', 'final-result'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });
        };
        
        // æ˜¾ç¤ºå•è¯çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
        function displayWordState(title, word, settings) {
            const nativeLang = languageInfo[settings.nativeLanguage];
            
            let html = `<div class="word-state">`;
            if (title) html += `<h4>${title}</h4>`;
            html += `<p><strong>å½“å‰æ¯è¯­:</strong> ${nativeLang ? `${nativeLang.flag} ${nativeLang.name}` : 'æœªè®¾ç½®'}</p>`;
            html += `<p><strong>å­¦ä¹ è¯­è¨€:</strong> ${settings.learningLanguages.map(code => languageInfo[code]?.name).join(', ')}</p>`;
            
            html += `<div class="native-note">æ¯è¯­æ³¨é‡Š: ${word.nativeNote || 'æ— '}</div>`;
            
            html += '<p><strong>ç¿»è¯‘:</strong></p>';
            if (word.translations.length > 0) {
                word.translations.forEach(t => {
                    const lang = languageInfo[t.language];
                    html += `<span class="translation">${lang?.flag} ${lang?.name}: ${t.text}</span>`;
                });
            } else {
                html += '<span style="color: #666;">æ— ç¿»è¯‘</span>';
            }
            
            html += '</div>';
            
            return html;
        }
    </script>
</body>
</html>
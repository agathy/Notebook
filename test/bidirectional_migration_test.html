<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå‘è¿ç§»æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        
        .word-state {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .native-note {
            background: #fff3e0;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-weight: bold;
            border-left: 3px solid #ff9800;
        }
        
        .translation {
            display: inline-block;
            margin: 3px 5px;
            padding: 4px 10px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #2196f3;
        }
        
        .step-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ åŒå‘è¿ç§»æµ‹è¯•</h1>
    
    <div class="result info">
        <strong>ğŸ“‹ æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯å½“åŸæ¯è¯­å˜æˆå­¦ä¹ è¯­è¨€æ—¶ï¼Œæ¯è¯­æ³¨é‡Šèƒ½æ­£ç¡®è½¬æ¢ä¸ºè¯¥è¯­è¨€çš„ç¿»è¯‘
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 1: åˆå§‹åŒ–æµ‹è¯•æ•°æ®</div>
        <button onclick="initializeTest()">åˆ›å»ºæµ‹è¯•æ•°æ®</button>
        <div id="init-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 2: æ˜¾ç¤ºåˆå§‹çŠ¶æ€</div>
        <button onclick="showState('åˆå§‹çŠ¶æ€')">æ˜¾ç¤ºå½“å‰çŠ¶æ€</button>
        <div id="state-display"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 3: ç¬¬ä¸€æ¬¡è¯­è¨€åˆ‡æ¢ï¼ˆä¸­æ–‡â†’è‹±è¯­ï¼‰</div>
        <button onclick="switchLanguage('zh', 'en', 'ç¬¬ä¸€æ¬¡åˆ‡æ¢')">ä¸­æ–‡ â†’ è‹±è¯­</button>
        <div id="switch1-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 4: ç¬¬äºŒæ¬¡è¯­è¨€åˆ‡æ¢ï¼ˆè‹±è¯­â†’éŸ©è¯­ï¼‰</div>
        <button onclick="switchLanguage('en', 'ko', 'ç¬¬äºŒæ¬¡åˆ‡æ¢')">è‹±è¯­ â†’ éŸ©è¯­</button>
        <div id="switch2-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 5: ç¬¬ä¸‰æ¬¡è¯­è¨€åˆ‡æ¢ï¼ˆéŸ©è¯­â†’ä¸­æ–‡ï¼‰</div>
        <button onclick="switchLanguage('ko', 'zh', 'ç¬¬ä¸‰æ¬¡åˆ‡æ¢')">éŸ©è¯­ â†’ ä¸­æ–‡</button>
        <div id="switch3-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ­¥éª¤ 6: éªŒè¯æœ€ç»ˆç»“æœ</div>
        <button onclick="verifyFinalResult()">éªŒè¯ç»“æœ</button>
        <div id="final-verification"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">æ¸…ç†</div>
        <button onclick="cleanup()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
        <div id="cleanup-result"></div>
    </div>

    <script type="module">
        // ç®€åŒ–æµ‹è¯•ï¼Œç›´æ¥ä½¿ç”¨localStorage
        
        let testWord = null;
        let userSettings = null;
        
        // è¯­è¨€ä¿¡æ¯
        const languageInfo = {
            zh: { code: 'zh', name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
            en: { code: 'en', name: 'è‹±è¯­', flag: 'ğŸ‡ºğŸ‡¸' },
            ko: { code: 'ko', name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·' }
        };
        
        // åˆå§‹åŒ–æµ‹è¯•
        window.initializeTest = function() {
            try {
                // åˆ›å»ºæµ‹è¯•å•è¯
                testWord = {
                    id: 'test1',
                    translations: [
                        { language: 'en', text: 'apple', phonetic: '/ËˆÃ¦pÉ™l/', example: '', audio: null },
                        { language: 'ko', text: 'ì‚¬ê³¼', phonetic: 'sagwa', example: '', audio: null }
                    ],
                    nativeNote: 'çº¢è‰²çš„æ°´æœ',  // ä¸­æ–‡æ¯è¯­æ³¨é‡Š
                    image: null,
                    tags: ['æ°´æœ']
                };
                
                userSettings = {
                    nativeLanguage: 'zh',  // åˆå§‹æ¯è¯­æ˜¯ä¸­æ–‡
                    learningLanguages: ['en', 'ko']
                };
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('polyglotWords', JSON.stringify([testWord]));
                localStorage.setItem('polyglotSettings', JSON.stringify(userSettings));
                
                document.getElementById('init-result').innerHTML = 
                    '<div class="result success">âœ… æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ</div>';
                
                showState('åˆå§‹çŠ¶æ€');
                
            } catch (error) {
                document.getElementById('init-result').innerHTML = 
                    `<div class="result error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        window.showState = function(title) {
            if (!testWord || !userSettings) {
                document.getElementById('state-display').innerHTML = 
                    '<div class="result warning">âš ï¸ è¯·å…ˆåˆå§‹åŒ–æµ‹è¯•æ•°æ®</div>';
                return;
            }
            
            const nativeLang = languageInfo[userSettings.nativeLanguage];
            
            let html = `<div class="word-state">`;
            html += `<h3>${title}</h3>`;
            html += `<p><strong>å½“å‰æ¯è¯­:</strong> ${nativeLang ? `${nativeLang.flag} ${nativeLang.name}` : 'æœªè®¾ç½®'}</p>`;
            html += `<p><strong>å­¦ä¹ è¯­è¨€:</strong> ${userSettings.learningLanguages.map(code => languageInfo[code]?.name).join(', ')}</p>`;
            
            html += `<div class="native-note">æ¯è¯­æ³¨é‡Š: ${testWord.nativeNote || 'æ— '}</div>`;
            
            html += '<p><strong>ç¿»è¯‘:</strong></p>';
            if (testWord.translations.length > 0) {
                testWord.translations.forEach(t => {
                    const lang = languageInfo[t.language];
                    html += `<span class="translation">${lang?.flag} ${lang?.name}: ${t.text}</span>`;
                });
            } else {
                html += '<span style="color: #666;">æ— ç¿»è¯‘</span>';
            }
            
            html += '</div>';
            
            document.getElementById('state-display').innerHTML = html;
        };
        
        // æ¨¡æ‹Ÿè¯­è¨€åˆ‡æ¢
        window.switchLanguage = async function(fromLang, toLang, stepName) {
            if (!testWord || !userSettings) {
                return;
            }
            
            const resultId = stepName === 'ç¬¬ä¸€æ¬¡åˆ‡æ¢' ? 'switch1-result' : 
                            stepName === 'ç¬¬äºŒæ¬¡åˆ‡æ¢' ? 'switch2-result' : 'switch3-result';
            
            try {
                const fromLangInfo = languageInfo[fromLang];
                const toLangInfo = languageInfo[toLang];
                
                let html = `<h4>${stepName}: ${fromLangInfo?.name} â†’ ${toLangInfo?.name}</h4>`;
                
                // è®°å½•åˆ‡æ¢å‰çŠ¶æ€
                const beforeNote = testWord.nativeNote;
                const beforeTranslations = [...testWord.translations];
                
                html += `<p><strong>åˆ‡æ¢å‰:</strong></p>`;
                html += `<p>æ¯è¯­æ³¨é‡Š: "${beforeNote}"</p>`;
                html += `<p>ç¿»è¯‘: ${beforeTranslations.map(t => `${t.language}:${t.text}`).join(', ')}</p>`;
                
                // æ‰§è¡Œè¿ç§»é€»è¾‘ï¼ˆæ¨¡æ‹ŸmigrateLanguageDataï¼‰
                const previousNative = userSettings.nativeLanguage;
                
                // æ›´æ–°è®¾ç½®
                userSettings.nativeLanguage = toLang;
                userSettings.learningLanguages = userSettings.learningLanguages.filter(lang => lang !== toLang);
                if (!userSettings.learningLanguages.includes(fromLang)) {
                    userSettings.learningLanguages.push(fromLang);
                }
                
                // æ‰§è¡ŒåŒå‘è¿ç§»é€»è¾‘
                const originalNativeNote = testWord.nativeNote;
                
                // æ­¥éª¤1: æŸ¥æ‰¾æ–°æ¯è¯­çš„ç¿»è¯‘
                const nativeTranslation = testWord.translations.find(t => t.language === toLang);
                if (nativeTranslation && nativeTranslation.text) {
                    testWord.nativeNote = nativeTranslation.text;
                    testWord.translations = testWord.translations.filter(t => t.language !== toLang);
                    html += `<div class="result info">ğŸ“ å°† ${toLangInfo?.name} ç¿»è¯‘ "${nativeTranslation.text}" è®¾ç½®ä¸ºæ¯è¯­æ³¨é‡Š</div>`;
                }
                
                // æ­¥éª¤2: å°†åŸæ¯è¯­æ³¨é‡Šè½¬æ¢ä¸ºç¿»è¯‘
                if (previousNative && 
                    originalNativeNote && 
                    userSettings.learningLanguages.includes(previousNative)) {
                    
                    const existingTranslation = testWord.translations.find(t => t.language === previousNative);
                    if (!existingTranslation) {
                        testWord.translations.push({
                            language: previousNative,
                            text: originalNativeNote,
                            phonetic: '',
                            example: '',
                            audio: null
                        });
                        html += `<div class="result success">âœ… å°†åŸæ¯è¯­æ³¨é‡Š "${originalNativeNote}" è½¬æ¢ä¸º ${fromLangInfo?.name} ç¿»è¯‘</div>`;
                    }
                }
                
                // è®°å½•åˆ‡æ¢åçŠ¶æ€
                html += `<p><strong>åˆ‡æ¢å:</strong></p>`;
                html += `<p>æ¯è¯­æ³¨é‡Š: "${testWord.nativeNote}"</p>`;
                html += `<p>ç¿»è¯‘: ${testWord.translations.map(t => `${t.language}:${t.text}`).join(', ')}</p>`;
                
                // ä¿å­˜æ›´æ–°
                localStorage.setItem('polyglotWords', JSON.stringify([testWord]));
                localStorage.setItem('polyglotSettings', JSON.stringify(userSettings));
                
                document.getElementById(resultId).innerHTML = html;
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                showState(`${stepName}åçŠ¶æ€`);
                
            } catch (error) {
                document.getElementById(resultId).innerHTML = 
                    `<div class="result error">âŒ ${stepName}å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // éªŒè¯æœ€ç»ˆç»“æœ
        window.verifyFinalResult = function() {
            if (!testWord || !userSettings) {
                document.getElementById('final-verification').innerHTML = 
                    '<div class="result warning">âš ï¸ è¯·å…ˆå®Œæˆæ‰€æœ‰æµ‹è¯•æ­¥éª¤</div>';
                return;
            }
            
            let html = '<h3>ğŸ” æœ€ç»ˆéªŒè¯ç»“æœ</h3>';
            let allPassed = true;
            
            // éªŒè¯1: æ£€æŸ¥å½“å‰æ¯è¯­æ³¨é‡Š
            if (testWord.nativeNote === 'çº¢è‰²çš„æ°´æœ') {
                html += '<div class="result success">âœ… æ¯è¯­æ³¨é‡Šæ­£ç¡®: "çº¢è‰²çš„æ°´æœ" (ä¸­æ–‡)</div>';
            } else {
                html += `<div class="result error">âŒ æ¯è¯­æ³¨é‡Šé”™è¯¯: æœŸæœ› "çº¢è‰²çš„æ°´æœ"ï¼Œå®é™… "${testWord.nativeNote}"</div>`;
                allPassed = false;
            }
            
            // éªŒè¯2: æ£€æŸ¥æ˜¯å¦æœ‰è‹±è¯­ç¿»è¯‘
            const englishTranslation = testWord.translations.find(t => t.language === 'en');
            if (englishTranslation && englishTranslation.text === 'apple') {
                html += '<div class="result success">âœ… è‹±è¯­ç¿»è¯‘æ­£ç¡®ä¿ç•™: "apple"</div>';
            } else {
                html += '<div class="result error">âŒ è‹±è¯­ç¿»è¯‘ä¸¢å¤±æˆ–é”™è¯¯</div>';
                allPassed = false;
            }
            
            // éªŒè¯3: æ£€æŸ¥æ˜¯å¦æœ‰éŸ©è¯­ç¿»è¯‘
            const koreanTranslation = testWord.translations.find(t => t.language === 'ko');
            if (koreanTranslation && koreanTranslation.text === 'ì‚¬ê³¼') {
                html += '<div class="result success">âœ… éŸ©è¯­ç¿»è¯‘æ­£ç¡®ä¿ç•™: "ì‚¬ê³¼"</div>';
            } else {
                html += '<div class="result error">âŒ éŸ©è¯­ç¿»è¯‘ä¸¢å¤±æˆ–é”™è¯¯</div>';
                allPassed = false;
            }
            
            // éªŒè¯4: æ£€æŸ¥ç¿»è¯‘æ€»æ•°
            if (testWord.translations.length === 2) {
                html += '<div class="result success">âœ… ç¿»è¯‘æ•°é‡æ­£ç¡®: 2ä¸ª</div>';
            } else {
                html += `<div class="result error">âŒ ç¿»è¯‘æ•°é‡é”™è¯¯: æœŸæœ›2ä¸ªï¼Œå®é™…${testWord.translations.length}ä¸ª</div>`;
                allPassed = false;
            }
            
            // æ€»ç»“
            if (allPassed) {
                html += '<div class="result success"><strong>ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼åŒå‘è¿ç§»åŠŸèƒ½æ­£å¸¸å·¥ä½œ</strong></div>';
            } else {
                html += '<div class="result error"><strong>âŒ éªŒè¯å¤±è´¥ï¼ŒåŒå‘è¿ç§»å­˜åœ¨é—®é¢˜</strong></div>';
            }
            
            document.getElementById('final-verification').innerHTML = html;
        };
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        window.cleanup = function() {
            localStorage.removeItem('polyglotWords');
            localStorage.removeItem('polyglotSettings');
            testWord = null;
            userSettings = null;
            
            document.getElementById('cleanup-result').innerHTML = 
                '<div class="result success">âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†</div>';
            
            // æ¸…ç©ºæ‰€æœ‰æ˜¾ç¤ºåŒºåŸŸ
            ['init-result', 'state-display', 'switch1-result', 'switch2-result', 
             'switch3-result', 'final-verification'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });
        };
    </script>
</body>
</html>
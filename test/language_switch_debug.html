<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯è¯­åˆ‡æ¢è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .result {
            background: #f0f8ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .error {
            background: #ffe6e6;
            border-left-color: #d00;
            color: #d00;
        }
        .success {
            background: #e6ffe6;
            border-left-color: #080;
            color: #080;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .word-item {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .word-translations {
            margin: 5px 0;
        }
        .translation {
            display: inline-block;
            margin: 2px 5px;
            padding: 2px 8px;
            background: #e3f2fd;
            border-radius: 12px;
            font-size: 0.9em;
        }
        .native-note {
            background: #fff3e0;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .current-settings {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>æ¯è¯­åˆ‡æ¢è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>å½“å‰è®¾ç½®</h2>
        <div id="current-settings" class="current-settings">åŠ è½½ä¸­...</div>
        <button onclick="refreshSettings()">åˆ·æ–°è®¾ç½®</button>
    </div>
    
    <div class="section">
        <h2>æµ‹è¯•æ•°æ®ç®¡ç†</h2>
        <button onclick="createTestData()">åˆ›å»ºæµ‹è¯•å•è¯</button>
        <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <div id="data-result"></div>
    </div>
    
    <div class="section">
        <h2>å½“å‰å•è¯</h2>
        <div id="words-display">æš‚æ— å•è¯</div>
        <button onclick="refreshWords()">åˆ·æ–°å•è¯æ˜¾ç¤º</button>
    </div>
    
    <div class="section">
        <h2>æ¯è¯­åˆ‡æ¢æµ‹è¯•</h2>
        <p>é€‰æ‹©æ–°çš„æ¯è¯­æ¥æµ‹è¯•åˆ‡æ¢é€»è¾‘ï¼š</p>
        <button onclick="switchLanguage('zh')">åˆ‡æ¢åˆ°ä¸­æ–‡ ğŸ‡¨ğŸ‡³</button>
        <button onclick="switchLanguage('en')">åˆ‡æ¢åˆ°è‹±è¯­ ğŸ‡ºğŸ‡¸</button>
        <button onclick="switchLanguage('ko')">åˆ‡æ¢åˆ°éŸ©è¯­ ğŸ‡°ğŸ‡·</button>
        <button onclick="switchLanguage('ja')">åˆ‡æ¢åˆ°æ—¥è¯­ ğŸ‡¯ğŸ‡µ</button>
        <div id="switch-result"></div>
        
        <h3>æµ‹è¯•æ­¥éª¤ï¼š</h3>
        <ol>
            <li>ç‚¹å‡»"åˆ›å»ºæµ‹è¯•å•è¯"æŒ‰é’®</li>
            <li>è§‚å¯Ÿå½“å‰å•è¯çš„æ¯è¯­æ³¨é‡Š</li>
            <li>ç‚¹å‡»ä¸åŒçš„è¯­è¨€åˆ‡æ¢æŒ‰é’®</li>
            <li>è§‚å¯Ÿæ¯è¯­æ³¨é‡Šæ˜¯å¦æ­£ç¡®å˜åŒ–ä¸ºè¯¥è¯­è¨€çš„å†…å®¹</li>
        </ol>
    </div>

    <script type="module">
        import { 
            initUserSettings, 
            userSettings, 
            availableLanguages,
            migrateLanguageData,
            saveSettingsToStorage,
            getLanguageInfo
        } from '../js/modules/userSettings.js';
        import { 
            initWordManager, 
            words, 
            addWord, 
            saveWordsToStorage 
        } from '../js/modules/wordManager.js';

        // åˆå§‹åŒ–æ ‡å¿—
        let initialized = false;

        function init() {
            if (initialized) return;
            
            // åˆå§‹åŒ–ç”¨æˆ·è®¾ç½®
            initUserSettings({
                showMessage: (msg, type) => {
                    console.log(`[${type}] ${msg}`);
                    const resultDiv = document.getElementById('switch-result');
                    if (resultDiv) {
                        resultDiv.innerHTML += `<div class="result ${type}">${msg}</div>`;
                    }
                },
                nativeLanguageOptionsEl: null,
                learningLanguageOptionsEl: null,
                selectedLanguagesEl: null,
                startAppBtn: null,
                languageSetupEl: null,
                mainAppEl: null
            });

            // åˆå§‹åŒ–å•è¯ç®¡ç†å™¨
            initWordManager({
                showMessage: (msg, type) => console.log(`[${type}] ${msg}`),
                updateAllTags: () => {},
                updateTagFilterSelect: () => {},
                updateHomeWordCount: () => {},
                updateWordsTable: () => {},
                loadWords: () => {}
            });

            initialized = true;
        }

        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.refreshSettings = function() {
            init();
            const settingsDiv = document.getElementById('current-settings');
            const nativeLang = getLanguageInfo(userSettings.nativeLanguage);
            const learningLangs = userSettings.learningLanguages.map(code => 
                getLanguageInfo(code)?.name || code
            ).join(', ');
            
            settingsDiv.innerHTML = `
                <strong>æ¯è¯­:</strong> ${nativeLang ? `${nativeLang.flag} ${nativeLang.name} (${nativeLang.code})` : 'æœªè®¾ç½®'}<br>
                <strong>å­¦ä¹ è¯­è¨€:</strong> ${learningLangs || 'æœªè®¾ç½®'}
            `;
        };

        window.createTestData = function() {
            init();
            
            // åˆ›å»ºæµ‹è¯•å•è¯
            const testWords = [
                {
                    translations: [
                        { language: 'en', text: 'apple', phonetic: '/ËˆÃ¦pÉ™l/', example: 'I eat an apple.', audio: null },
                        { language: 'zh', text: 'è‹¹æœ', phonetic: 'pÃ­ng guÇ’', example: 'æˆ‘åƒè‹¹æœã€‚', audio: null },
                        { language: 'ko', text: 'ì‚¬ê³¼', phonetic: 'sagwa', example: 'ì‚¬ê³¼ë¥¼ ë¨¹ì–´ìš”.', audio: null },
                        { language: 'ja', text: 'ã‚Šã‚“ã”', phonetic: 'ringo', example: 'ã‚Šã‚“ã”ã‚’é£Ÿã¹ã¾ã™ã€‚', audio: null }
                    ],
                    nativeNote: 'çº¢è‰²çš„æ°´æœ',
                    image: null,
                    tags: ['æ°´æœ', 'é£Ÿç‰©']
                },
                {
                    translations: [
                        { language: 'en', text: 'car', phonetic: '/kÉ‘Ër/', example: 'I drive a car.', audio: null },
                        { language: 'zh', text: 'æ±½è½¦', phonetic: 'qÃ¬ chÄ“', example: 'æˆ‘å¼€æ±½è½¦ã€‚', audio: null },
                        { language: 'ko', text: 'ìë™ì°¨', phonetic: 'jadongcha', example: 'ìë™ì°¨ë¥¼ ìš´ì „í•©ë‹ˆë‹¤.', audio: null },
                        { language: 'ja', text: 'è»Š', phonetic: 'kuruma', example: 'è»Šã‚’é‹è»¢ã—ã¾ã™ã€‚', audio: null }
                    ],
                    nativeNote: 'äº¤é€šå·¥å…·',
                    image: null,
                    tags: ['äº¤é€š', 'è½¦è¾†']
                },
                {
                    translations: [
                        { language: 'en', text: 'book', phonetic: '/bÊŠk/', example: 'I read a book.', audio: null },
                        { language: 'zh', text: 'ä¹¦', phonetic: 'shÅ«', example: 'æˆ‘è¯»ä¹¦ã€‚', audio: null },
                        { language: 'ko', text: 'ì±…', phonetic: 'chaek', example: 'ì±…ì„ ì½ì–´ìš”.', audio: null },
                        { language: 'ja', text: 'æœ¬', phonetic: 'hon', example: 'æœ¬ã‚’èª­ã¿ã¾ã™ã€‚', audio: null }
                    ],
                    nativeNote: 'é˜…è¯»ææ–™',
                    image: null,
                    tags: ['å­¦ä¹ ', 'é˜…è¯»']
                }
            ];

            let addedCount = 0;
            testWords.forEach(wordData => {
                if (addWord(wordData)) {
                    addedCount++;
                }
            });

            document.getElementById('data-result').innerHTML = 
                `<div class="result success">å·²åˆ›å»º ${addedCount} ä¸ªæµ‹è¯•å•è¯</div>`;
            
            refreshWords();
        };

        window.clearAllData = function() {
            init();
            // æ¸…é™¤æ‰€æœ‰å•è¯
            words.length = 0;
            saveWordsToStorage();
            
            // é‡ç½®ç”¨æˆ·è®¾ç½®
            userSettings.nativeLanguage = null;
            userSettings.learningLanguages = [];
            saveSettingsToStorage();
            
            document.getElementById('data-result').innerHTML = 
                '<div class="result">å·²æ¸…é™¤æ‰€æœ‰æ•°æ®</div>';
            refreshWords();
            refreshSettings();
        };

        window.refreshWords = function() {
            init();
            const wordsDiv = document.getElementById('words-display');
            
            if (words.length === 0) {
                wordsDiv.innerHTML = '<div class="word-item">æš‚æ— å•è¯</div>';
                return;
            }

            let html = '';
            words.forEach((word, index) => {
                const translationsHtml = word.translations.map(t => 
                    `<span class="translation"><strong>${getLanguageInfo(t.language)?.flag || 'ğŸŒ'} ${getLanguageInfo(t.language)?.name || t.language}:</strong> ${t.text}</span>`
                ).join('');
                
                html += `
                    <div class="word-item">
                        <strong>å•è¯ ${index + 1} (ID: ${word.id})</strong><br>
                        <div class="word-translations">${translationsHtml}</div>
                        <div class="native-note"><strong>æ¯è¯­æ³¨é‡Š:</strong> ${word.nativeNote || 'æ— '}</div>
                        <div><strong>æ ‡ç­¾:</strong> ${word.tags ? word.tags.join(', ') : 'æ— '}</div>
                    </div>
                `;
            });
            
            wordsDiv.innerHTML = html;
        };

        window.switchLanguage = async function(newLanguageCode) {
            init();
            
            const previousNative = userSettings.nativeLanguage;
            const resultDiv = document.getElementById('switch-result');
            
            // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
            resultDiv.innerHTML = '';
            
            try {
                console.log(`åˆ‡æ¢è¯­è¨€: ${previousNative} -> ${newLanguageCode}`);
                
                // è®¾ç½®æ–°çš„æ¯è¯­
                userSettings.nativeLanguage = newLanguageCode;
                
                // ç¡®ä¿æ–°æ¯è¯­ä¸åœ¨å­¦ä¹ è¯­è¨€ä¸­
                if (userSettings.learningLanguages.includes(newLanguageCode)) {
                    userSettings.learningLanguages = userSettings.learningLanguages.filter(lang => lang !== newLanguageCode);
                }
                
                // å¦‚æœä¹‹å‰çš„æ¯è¯­ä¸åœ¨å­¦ä¹ è¯­è¨€ä¸­ï¼Œæ·»åŠ å®ƒ
                if (previousNative && !userSettings.learningLanguages.includes(previousNative)) {
                    userSettings.learningLanguages.push(previousNative);
                }
                
                // ä¿å­˜è®¾ç½®
                saveSettingsToStorage();
                
                console.log('å¼€å§‹æ‰§è¡Œæ•°æ®è¿ç§»...');
                
                // æ‰§è¡Œæ•°æ®è¿ç§»
                const result = await migrateLanguageData(previousNative);
                
                const newLangName = getLanguageInfo(newLanguageCode)?.name || newLanguageCode;
                const prevLangName = getLanguageInfo(previousNative)?.name || previousNative;
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <strong>åˆ‡æ¢æˆåŠŸ!</strong><br>
                        ä» ${prevLangName} åˆ‡æ¢åˆ° ${newLangName}<br>
                        ${result.message}
                    </div>
                `;
                
                console.log('æ•°æ®è¿ç§»å®Œæˆ:', result);
                
                // åˆ·æ–°æ˜¾ç¤º
                refreshSettings();
                refreshWords();
                
            } catch (error) {
                console.error('åˆ‡æ¢å¤±è´¥:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <strong>åˆ‡æ¢å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®åˆå§‹è¯­è¨€è®¾ç½®ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
            if (!localStorage.getItem('polyglotSettings')) {
                userSettings.nativeLanguage = 'zh';
                userSettings.learningLanguages = ['en', 'ko', 'ja'];
                saveSettingsToStorage();
            }
            
            refreshSettings();
            refreshWords();
        });
    </script>
</body>
</html>
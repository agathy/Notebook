<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆéªŒè¯ - æ¯è¯­åˆ‡æ¢åŠŸèƒ½</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .word-display {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .native-note {
            background: #fff3e0;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-weight: bold;
            border-left: 3px solid #ff9800;
        }
        
        .translations {
            margin: 8px 0;
        }
        
        .translation {
            display: inline-block;
            margin: 3px 5px;
            padding: 4px 10px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #2196f3;
        }
        
        .step {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ¯è¯­åˆ‡æ¢åŠŸèƒ½ - æœ€ç»ˆéªŒè¯</h1>
    
    <div class="status info">
        <strong>ğŸ“‹ éªŒè¯ç›®æ ‡ï¼š</strong>ç¡®è®¤æ¯è¯­åˆ‡æ¢æ—¶ï¼Œå•è¯çš„æ¯è¯­æ³¨é‡Šèƒ½æ­£ç¡®æ›´æ–°ä¸ºè¯¥è¯­è¨€çš„å†…å®¹
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
        <div id="system-status"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•</h2>
        
        <div class="step">
            <strong>æ­¥éª¤ 1:</strong> åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
            <br><button onclick="initializeTest()">åˆå§‹åŒ–æµ‹è¯•æ•°æ®</button>
            <div id="init-status"></div>
        </div>
        
        <div class="step">
            <strong>æ­¥éª¤ 2:</strong> æŸ¥çœ‹å½“å‰çŠ¶æ€
            <br><button onclick="showCurrentState()">æ˜¾ç¤ºå½“å‰çŠ¶æ€</button>
            <div id="current-state"></div>
        </div>
        
        <div class="step">
            <strong>æ­¥éª¤ 3:</strong> æ‰§è¡Œæ¯è¯­åˆ‡æ¢æµ‹è¯•
            <br>
            <button onclick="testSwitch('zh', 'en')">ä¸­æ–‡ â†’ è‹±è¯­</button>
            <button onclick="testSwitch('en', 'ko')">è‹±è¯­ â†’ éŸ©è¯­</button>
            <button onclick="testSwitch('ko', 'zh')">éŸ©è¯­ â†’ ä¸­æ–‡</button>
            <div id="switch-results"></div>
        </div>
        
        <div class="step">
            <strong>æ­¥éª¤ 4:</strong> éªŒè¯ç»“æœ
            <br><button onclick="verifyResults()">éªŒè¯æœ€ç»ˆç»“æœ</button>
            <div id="verification-results"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ§¹ æ¸…ç†</h2>
        <button onclick="cleanup()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
        <div id="cleanup-status"></div>
    </div>

    <script type="module">
        // å¯¼å…¥å¿…è¦çš„æ¨¡å—
        import { 
            initUserSettings, 
            userSettings, 
            availableLanguages,
            migrateLanguageData,
            saveSettingsToStorage,
            getLanguageInfo
        } from '../js/modules/userSettings.js';
        
        import { 
            initWordManager, 
            words, 
            addWord, 
            saveWordsToStorage 
        } from '../js/modules/wordManager.js';
        
        let testInitialized = false;
        
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.checkSystemStatus = function() {
            const statusDiv = document.getElementById('system-status');
            let html = '<h3>ğŸ” ç³»ç»Ÿæ£€æŸ¥ç»“æœ</h3>';
            
            try {
                // æ£€æŸ¥æ¨¡å—æ˜¯å¦æ­£ç¡®åŠ è½½
                html += '<div class="status success">âœ… æ¨¡å—åŠ è½½æˆåŠŸ</div>';
                
                // æ£€æŸ¥localStorageå¯ç”¨æ€§
                if (typeof Storage !== "undefined") {
                    html += '<div class="status success">âœ… localStorage å¯ç”¨</div>';
                } else {
                    html += '<div class="status error">âŒ localStorage ä¸å¯ç”¨</div>';
                }
                
                // æ£€æŸ¥è¯­è¨€é…ç½®
                if (availableLanguages && availableLanguages.length > 0) {
                    html += `<div class="status success">âœ… è¯­è¨€é…ç½®å·²åŠ è½½ (${availableLanguages.length} ç§è¯­è¨€)</div>`;
                } else {
                    html += '<div class="status error">âŒ è¯­è¨€é…ç½®æœªåŠ è½½</div>';
                }
                
                // æ£€æŸ¥æ ¸å¿ƒå‡½æ•°
                if (typeof migrateLanguageData === 'function') {
                    html += '<div class="status success">âœ… æ ¸å¿ƒè¿ç§»å‡½æ•°å¯ç”¨</div>';
                } else {
                    html += '<div class="status error">âŒ æ ¸å¿ƒè¿ç§»å‡½æ•°ä¸å¯ç”¨</div>';
                }
                
            } catch (error) {
                html += `<div class="status error">âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
            
            statusDiv.innerHTML = html;
        };
        
        // åˆå§‹åŒ–æµ‹è¯•
        window.initializeTest = function() {
            const statusDiv = document.getElementById('init-status');
            
            try {
                // åˆå§‹åŒ–ç”¨æˆ·è®¾ç½®
                initUserSettings({
                    showMessage: (msg, type) => console.log(`[${type}] ${msg}`),
                    nativeLanguageOptionsEl: null,
                    learningLanguageOptionsEl: null,
                    selectedLanguagesEl: null,
                    startAppBtn: null,
                    languageSetupEl: null,
                    mainAppEl: null
                });
                
                // åˆå§‹åŒ–å•è¯ç®¡ç†å™¨
                initWordManager({
                    showMessage: (msg, type) => console.log(`[${type}] ${msg}`),
                    updateAllTags: () => {},
                    updateTagFilterSelect: () => {},
                    updateHomeWordCount: () => {},
                    updateWordsTable: () => {},
                    loadWords: () => {}
                });
                
                // è®¾ç½®åˆå§‹è¯­è¨€é…ç½®
                userSettings.nativeLanguage = 'zh';
                userSettings.learningLanguages = ['en', 'ko'];
                saveSettingsToStorage();
                
                // åˆ›å»ºæµ‹è¯•å•è¯
                const testWord = {
                    translations: [
                        { language: 'en', text: 'apple', phonetic: '/ËˆÃ¦pÉ™l/', example: 'I eat an apple.', audio: null },
                        { language: 'zh', text: 'è‹¹æœ', phonetic: 'pÃ­ng guÇ’', example: 'æˆ‘åƒè‹¹æœã€‚', audio: null },
                        { language: 'ko', text: 'ì‚¬ê³¼', phonetic: 'sagwa', example: 'ì‚¬ê³¼ë¥¼ ë¨¹ì–´ìš”.', audio: null }
                    ],
                    nativeNote: 'çº¢è‰²çš„æ°´æœ',
                    image: null,
                    tags: ['æ°´æœ', 'é£Ÿç‰©']
                };
                
                // æ¸…ç©ºç°æœ‰å•è¯å¹¶æ·»åŠ æµ‹è¯•å•è¯
                words.length = 0;
                addWord(testWord);
                
                testInitialized = true;
                statusDiv.innerHTML = '<div class="status success">âœ… æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ</div>';
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        window.showCurrentState = function() {
            const statusDiv = document.getElementById('current-state');
            
            if (!testInitialized) {
                statusDiv.innerHTML = '<div class="status warning">âš ï¸ è¯·å…ˆåˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ</div>';
                return;
            }
            
            try {
                const nativeLang = getLanguageInfo(userSettings.nativeLanguage);
                const learningLangs = userSettings.learningLanguages.map(code => getLanguageInfo(code)?.name).join(', ');
                
                let html = '<h3>ğŸ“‹ å½“å‰çŠ¶æ€</h3>';
                html += `<p><strong>æ¯è¯­:</strong> ${nativeLang ? `${nativeLang.flag} ${nativeLang.name}` : 'æœªè®¾ç½®'}</p>`;
                html += `<p><strong>å­¦ä¹ è¯­è¨€:</strong> ${learningLangs || 'æœªè®¾ç½®'}</p>`;
                html += `<p><strong>å•è¯æ•°é‡:</strong> ${words.length}</p>`;
                
                if (words.length > 0) {
                    html += '<div class="word-display">';
                    const word = words[0];
                    html += '<h4>æµ‹è¯•å•è¯:</h4>';
                    html += '<div class="translations">';
                    word.translations.forEach(t => {
                        const lang = getLanguageInfo(t.language);
                        html += `<span class="translation">${lang?.flag} ${t.text}</span>`;
                    });
                    html += '</div>';
                    html += `<div class="native-note">æ¯è¯­æ³¨é‡Š: ${word.nativeNote || 'æ— '}</div>`;
                    html += '</div>';
                }
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ çŠ¶æ€æ˜¾ç¤ºå¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æµ‹è¯•è¯­è¨€åˆ‡æ¢
        window.testSwitch = async function(fromLang, toLang) {
            const resultsDiv = document.getElementById('switch-results');
            
            if (!testInitialized) {
                resultsDiv.innerHTML = '<div class="status warning">âš ï¸ è¯·å…ˆåˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ</div>';
                return;
            }
            
            try {
                const fromLangInfo = getLanguageInfo(fromLang);
                const toLangInfo = getLanguageInfo(toLang);
                
                let html = `<h3>ğŸ”„ æµ‹è¯•åˆ‡æ¢: ${fromLangInfo?.name} â†’ ${toLangInfo?.name}</h3>`;
                
                // è®°å½•åˆ‡æ¢å‰çš„çŠ¶æ€
                const beforeNote = words[0]?.nativeNote;
                const beforeTranslations = words[0]?.translations.map(t => `${t.language}:${t.text}`).join(', ');
                
                html += `<p><strong>åˆ‡æ¢å‰:</strong></p>`;
                html += `<p>æ¯è¯­æ³¨é‡Š: "${beforeNote}"</p>`;
                html += `<p>ç¿»è¯‘: ${beforeTranslations}</p>`;
                
                // æ‰§è¡Œåˆ‡æ¢
                const previousNative = userSettings.nativeLanguage;
                userSettings.nativeLanguage = toLang;
                
                // æ›´æ–°å­¦ä¹ è¯­è¨€
                if (!userSettings.learningLanguages.includes(fromLang)) {
                    userSettings.learningLanguages.push(fromLang);
                }
                userSettings.learningLanguages = userSettings.learningLanguages.filter(lang => lang !== toLang);
                
                // æ‰§è¡Œæ•°æ®è¿ç§»
                const result = await migrateLanguageData(previousNative);
                
                // è®°å½•åˆ‡æ¢åçš„çŠ¶æ€
                const afterNote = words[0]?.nativeNote;
                const afterTranslations = words[0]?.translations.map(t => `${t.language}:${t.text}`).join(', ');
                
                html += `<p><strong>åˆ‡æ¢å:</strong></p>`;
                html += `<p>æ¯è¯­æ³¨é‡Š: "${afterNote}"</p>`;
                html += `<p>ç¿»è¯‘: ${afterTranslations}</p>`;
                
                // éªŒè¯ç»“æœ
                if (result.migratedCount > 0) {
                    html += `<div class="status success">âœ… ${result.message}</div>`;
                } else {
                    html += `<div class="status info">â„¹ï¸ ${result.message}</div>`;
                }
                
                // ä¿å­˜è®¾ç½®
                saveSettingsToStorage();
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">âŒ åˆ‡æ¢æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // éªŒè¯ç»“æœ
        window.verifyResults = function() {
            const resultsDiv = document.getElementById('verification-results');
            
            if (!testInitialized) {
                resultsDiv.innerHTML = '<div class="status warning">âš ï¸ è¯·å…ˆåˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ</div>';
                return;
            }
            
            try {
                let html = '<h3>âœ… éªŒè¯ç»“æœ</h3>';
                let allPassed = true;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å•è¯
                if (words.length === 0) {
                    html += '<div class="status error">âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•å•è¯</div>';
                    allPassed = false;
                } else {
                    html += '<div class="status success">âœ… æµ‹è¯•å•è¯å­˜åœ¨</div>';
                }
                
                // æ£€æŸ¥æ¯è¯­æ³¨é‡Šæ˜¯å¦æ­£ç¡®æ›´æ–°
                const word = words[0];
                const currentNativeLang = userSettings.nativeLanguage;
                const nativeLangInfo = getLanguageInfo(currentNativeLang);
                
                if (word && word.nativeNote) {
                    // æ£€æŸ¥æ¯è¯­æ³¨é‡Šæ˜¯å¦ä¸å½“å‰æ¯è¯­å¯¹åº”
                    const expectedNotes = {
                        'zh': 'è‹¹æœ',
                        'en': 'apple',
                        'ko': 'ì‚¬ê³¼'
                    };
                    
                    const expectedNote = expectedNotes[currentNativeLang];
                    if (word.nativeNote === expectedNote) {
                        html += `<div class="status success">âœ… æ¯è¯­æ³¨é‡Šæ­£ç¡®: "${word.nativeNote}" (${nativeLangInfo?.name})</div>`;
                    } else {
                        html += `<div class="status error">âŒ æ¯è¯­æ³¨é‡Šé”™è¯¯: æœŸæœ› "${expectedNote}"ï¼Œå®é™… "${word.nativeNote}"</div>`;
                        allPassed = false;
                    }
                } else {
                    html += '<div class="status error">âŒ æ¯è¯­æ³¨é‡Šä¸ºç©º</div>';
                    allPassed = false;
                }
                
                // æ£€æŸ¥ç¿»è¯‘æ˜¯å¦æ­£ç¡®
                if (word && word.translations) {
                    const hasCurrentNativeInTranslations = word.translations.some(t => t.language === currentNativeLang);
                    if (!hasCurrentNativeInTranslations) {
                        html += '<div class="status success">âœ… å½“å‰æ¯è¯­ä¸åœ¨ç¿»è¯‘åˆ—è¡¨ä¸­ï¼ˆæ­£ç¡®ï¼‰</div>';
                    } else {
                        html += '<div class="status error">âŒ å½“å‰æ¯è¯­ä»åœ¨ç¿»è¯‘åˆ—è¡¨ä¸­ï¼ˆé”™è¯¯ï¼‰</div>';
                        allPassed = false;
                    }
                }
                
                // æ€»ç»“
                if (allPassed) {
                    html += '<div class="status success"><strong>ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼æ¯è¯­åˆ‡æ¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ</strong></div>';
                } else {
                    html += '<div class="status error"><strong>âŒ éªŒè¯å¤±è´¥ï¼Œå­˜åœ¨é—®é¢˜éœ€è¦ä¿®å¤</strong></div>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">âŒ éªŒè¯å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        window.cleanup = function() {
            try {
                localStorage.removeItem('polyglotWords');
                localStorage.removeItem('polyglotSettings');
                words.length = 0;
                userSettings.nativeLanguage = null;
                userSettings.learningLanguages = [];
                testInitialized = false;
                
                document.getElementById('cleanup-status').innerHTML = 
                    '<div class="status success">âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†</div>';
                    
                // æ¸…ç©ºå…¶ä»–æ˜¾ç¤ºåŒºåŸŸ
                ['init-status', 'current-state', 'switch-results', 'verification-results'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
                
            } catch (error) {
                document.getElementById('cleanup-status').innerHTML = 
                    `<div class="status error">âŒ æ¸…ç†å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkSystemStatus();
            }, 500);
        });
    </script>
</body>
</html>
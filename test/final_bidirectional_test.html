<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆåŒå‘è¿ç§»æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-step {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }
        .result {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .word-state {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .native-note {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            border-left: 4px solid #ff9800;
            font-size: 16px;
        }
        
        .translation {
            display: inline-block;
            margin: 5px 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 20px;
            font-size: 14px;
            border: 2px solid #2196f3;
            font-weight: 500;
        }
        
        .step-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 16px;
        }
        
        .language-switch {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
        
        .verification-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .verification-item {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .pass { background: #d4edda; border-color: #28a745; }
        .fail { background: #f8d7da; border-color: #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸ”„ æœ€ç»ˆåŒå‘è¿ç§»æµ‹è¯•</h1>
    
    <div class="result info">
        <strong>ğŸ¯ æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯ä¿®å¤åçš„åŒå‘è¿ç§»é€»è¾‘æ˜¯å¦å®Œå…¨è§£å†³äº†ç”¨æˆ·åé¦ˆçš„é—®é¢˜ï¼š
        <br><em>"å½“è¯­è¨€aè¢«è®¾ç½®ä¸ºæ¯è¯­æ—¶,ä»–çš„å†…å®¹ä¼šå˜æˆæ¯è¯­æ³¨é‡Š,ä½†å½“æ¯è¯­bè¢«è®¾ç½®ä¸ºå­¦ä¹ è¯­è¨€æ—¶,æ¯è¯­æ³¨é‡Šä¸­çš„å†…å®¹ä¸ä¼šä¿ç•™åˆ°è¯­è¨€bé‡Œ"</em>
    </div>
    
    <div class="test-step">
        <div class="step-title">
            <div class="step-number">1</div>
            åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        </div>
        <p>åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸­æ–‡æ¯è¯­æ³¨é‡Šå’Œè‹±è¯­ã€éŸ©è¯­ç¿»è¯‘çš„æµ‹è¯•å•è¯</p>
        <button onclick="initializeTestEnvironment()">ğŸš€ åˆå§‹åŒ–æµ‹è¯•</button>
        <div id="init-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">
            <div class="step-number">2</div>
            ç¬¬ä¸€æ¬¡è¯­è¨€åˆ‡æ¢æµ‹è¯•
        </div>
        <div class="language-switch">
            <strong>åˆ‡æ¢ï¼šä¸­æ–‡(æ¯è¯­) â†’ è‹±è¯­(æ¯è¯­)</strong>
            <br>é¢„æœŸï¼šè‹±è¯­ç¿»è¯‘"apple"å˜æˆæ¯è¯­æ³¨é‡Šï¼Œä¸­æ–‡æ³¨é‡Š"çº¢è‰²çš„æ°´æœ"å˜æˆä¸­æ–‡ç¿»è¯‘
        </div>
        <button onclick="performLanguageSwitch('zh', 'en', 1)">ğŸ”„ æ‰§è¡Œç¬¬ä¸€æ¬¡åˆ‡æ¢</button>
        <div id="switch1-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">
            <div class="step-number">3</div>
            ç¬¬äºŒæ¬¡è¯­è¨€åˆ‡æ¢æµ‹è¯•
        </div>
        <div class="language-switch">
            <strong>åˆ‡æ¢ï¼šè‹±è¯­(æ¯è¯­) â†’ éŸ©è¯­(æ¯è¯­)</strong>
            <br>é¢„æœŸï¼šéŸ©è¯­ç¿»è¯‘"ì‚¬ê³¼"å˜æˆæ¯è¯­æ³¨é‡Šï¼Œè‹±è¯­æ³¨é‡Š"apple"å˜æˆè‹±è¯­ç¿»è¯‘
        </div>
        <button onclick="performLanguageSwitch('en', 'ko', 2)">ğŸ”„ æ‰§è¡Œç¬¬äºŒæ¬¡åˆ‡æ¢</button>
        <div id="switch2-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">
            <div class="step-number">4</div>
            å›å½’æµ‹è¯•
        </div>
        <div class="language-switch">
            <strong>åˆ‡æ¢ï¼šéŸ©è¯­(æ¯è¯­) â†’ ä¸­æ–‡(æ¯è¯­)</strong>
            <br>é¢„æœŸï¼šå›åˆ°åˆå§‹çŠ¶æ€ï¼Œæ‰€æœ‰æ•°æ®å®Œæ•´ä¿ç•™
        </div>
        <button onclick="performLanguageSwitch('ko', 'zh', 3)">ğŸ”„ æ‰§è¡Œå›å½’æµ‹è¯•</button>
        <div id="switch3-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">
            <div class="step-number">5</div>
            æœ€ç»ˆéªŒè¯
        </div>
        <p>éªŒè¯æ‰€æœ‰è¯­è¨€å†…å®¹æ˜¯å¦å®Œæ•´ä¿ç•™ï¼ŒåŒå‘è¿ç§»æ˜¯å¦æˆåŠŸ</p>
        <button onclick="performFinalVerification()">âœ… æ‰§è¡Œæœ€ç»ˆéªŒè¯</button>
        <div id="final-result"></div>
    </div>
    
    <div class="test-step">
        <div class="step-title">
            <div class="step-number">6</div>
            æ¸…ç†
        </div>
        <button onclick="cleanupTest()">ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ•°æ®</button>
        <div id="cleanup-result"></div>
    </div>

    <script type="module">
        // å¯¼å…¥å¿…è¦çš„æ¨¡å—
        import { migrateLanguageData, userSettings, selectNativeLanguage } from '../js/modules/userSettings.js';
        import { words, saveWordsToStorage } from '../js/modules/wordManager.js';
        
        let testWord = null;
        let originalSettings = null;
        let testResults = [];
        
        // è¯­è¨€ä¿¡æ¯
        const languageInfo = {
            zh: { code: 'zh', name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
            en: { code: 'en', name: 'è‹±è¯­', flag: 'ğŸ‡ºğŸ‡¸' },
            ko: { code: 'ko', name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·' }
        };
        
        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        window.initializeTestEnvironment = async function() {
            try {
                // ä¿å­˜åŸå§‹è®¾ç½®
                originalSettings = {
                    nativeLanguage: userSettings.nativeLanguage,
                    learningLanguages: [...userSettings.learningLanguages]
                };
                
                // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
                userSettings.nativeLanguage = 'zh';
                userSettings.learningLanguages = ['en', 'ko'];
                
                // åˆ›å»ºæµ‹è¯•å•è¯
                testWord = {
                    id: 'bidirectional-test-word',
                    translations: [
                        { language: 'en', text: 'apple', phonetic: '/ËˆÃ¦pÉ™l/', example: 'I eat an apple.', audio: null },
                        { language: 'ko', text: 'ì‚¬ê³¼', phonetic: 'sagwa', example: 'ì‚¬ê³¼ë¥¼ ë¨¹ì–´ìš”.', audio: null }
                    ],
                    nativeNote: 'çº¢è‰²çš„æ°´æœ',
                    image: null,
                    tags: ['æ°´æœ', 'æµ‹è¯•']
                };
                
                // æ·»åŠ åˆ°å•è¯åˆ—è¡¨
                const existingIndex = words.findIndex(w => w.id === testWord.id);
                if (existingIndex >= 0) {
                    words[existingIndex] = testWord;
                } else {
                    words.push(testWord);
                }
                
                // ä¿å­˜æ•°æ®
                saveWordsToStorage();
                
                let html = '<div class="result success">âœ… æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ</div>';
                html += displayWordState('åˆå§‹çŠ¶æ€', testWord, userSettings);
                
                document.getElementById('init-result').innerHTML = html;
                
            } catch (error) {
                document.getElementById('init-result').innerHTML = 
                    `<div class="result error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ‰§è¡Œè¯­è¨€åˆ‡æ¢
        window.performLanguageSwitch = async function(fromLang, toLang, stepNumber) {
            try {
                const fromLangInfo = languageInfo[fromLang];
                const toLangInfo = languageInfo[toLang];
                const resultId = `switch${stepNumber}-result`;
                
                let html = `<h4>ğŸ”„ æ‰§è¡Œåˆ‡æ¢: ${fromLangInfo.name} â†’ ${toLangInfo.name}</h4>`;
                
                // è®°å½•åˆ‡æ¢å‰çŠ¶æ€
                const beforeState = {
                    nativeNote: testWord.nativeNote,
                    translations: JSON.parse(JSON.stringify(testWord.translations)),
                    nativeLanguage: userSettings.nativeLanguage
                };
                
                html += displayWordState('åˆ‡æ¢å‰', testWord, userSettings);
                
                // æ‰§è¡Œè¯­è¨€åˆ‡æ¢
                const previousNative = userSettings.nativeLanguage;
                userSettings.nativeLanguage = toLang;
                
                // æ›´æ–°å­¦ä¹ è¯­è¨€åˆ—è¡¨
                userSettings.learningLanguages = userSettings.learningLanguages.filter(lang => lang !== toLang);
                if (!userSettings.learningLanguages.includes(fromLang)) {
                    userSettings.learningLanguages.push(fromLang);
                }
                
                // æ‰§è¡Œæ•°æ®è¿ç§»
                const migrationResult = await migrateLanguageData(previousNative);
                
                html += `<div class="result info">ğŸ“Š è¿ç§»ç»“æœ: ${migrationResult.message}</div>`;
                html += displayWordState('åˆ‡æ¢å', testWord, userSettings);
                
                // éªŒè¯å…³é”®ç‚¹
                const verifications = [];
                
                // éªŒè¯1: æ–°æ¯è¯­æ³¨é‡Šæ˜¯å¦æ­£ç¡®
                const expectedNewNote = beforeState.translations.find(t => t.language === toLang)?.text;
                if (expectedNewNote && testWord.nativeNote === expectedNewNote) {
                    verifications.push({ 
                        test: `æ–°æ¯è¯­æ³¨é‡Šæ­£ç¡® (${expectedNewNote})`, 
                        passed: true 
                    });
                } else {
                    verifications.push({ 
                        test: `æ–°æ¯è¯­æ³¨é‡Šé”™è¯¯ (æœŸæœ›: ${expectedNewNote}, å®é™…: ${testWord.nativeNote})`, 
                        passed: false 
                    });
                }
                
                // éªŒè¯2: åŸæ¯è¯­æ³¨é‡Šæ˜¯å¦è½¬æ¢ä¸ºç¿»è¯‘
                const originalNoteAsTranslation = testWord.translations.find(t => t.language === fromLang);
                if (originalNoteAsTranslation && originalNoteAsTranslation.text === beforeState.nativeNote) {
                    verifications.push({ 
                        test: `åŸæ¯è¯­æ³¨é‡Šæ­£ç¡®è½¬æ¢ä¸º${fromLangInfo.name}ç¿»è¯‘ (${beforeState.nativeNote})`, 
                        passed: true 
                    });
                } else {
                    verifications.push({ 
                        test: `åŸæ¯è¯­æ³¨é‡Šè½¬æ¢å¤±è´¥`, 
                        passed: false 
                    });
                }
                
                // éªŒè¯3: å…¶ä»–ç¿»è¯‘æ˜¯å¦ä¿ç•™
                const otherLanguages = ['zh', 'en', 'ko'].filter(lang => lang !== toLang);
                otherLanguages.forEach(lang => {
                    const beforeTranslation = beforeState.translations.find(t => t.language === lang);
                    const afterTranslation = testWord.translations.find(t => t.language === lang);
                    
                    if (lang === fromLang) {
                        // åŸæ¯è¯­åº”è¯¥æœ‰æ–°çš„ç¿»è¯‘ï¼ˆåŸæ¯è¯­æ³¨é‡Šï¼‰
                        if (afterTranslation && afterTranslation.text === beforeState.nativeNote) {
                            verifications.push({ 
                                test: `${languageInfo[lang].name}ç¿»è¯‘æ­£ç¡®ä¿ç•™`, 
                                passed: true 
                            });
                        }
                    } else {
                        // å…¶ä»–è¯­è¨€ç¿»è¯‘åº”è¯¥ä¿æŒä¸å˜
                        if (beforeTranslation && afterTranslation && beforeTranslation.text === afterTranslation.text) {
                            verifications.push({ 
                                test: `${languageInfo[lang].name}ç¿»è¯‘æ­£ç¡®ä¿ç•™ (${afterTranslation.text})`, 
                                passed: true 
                            });
                        } else if (!beforeTranslation && !afterTranslation) {
                            verifications.push({ 
                                test: `${languageInfo[lang].name}ç¿»è¯‘çŠ¶æ€æ­£ç¡®`, 
                                passed: true 
                            });
                        } else {
                            verifications.push({ 
                                test: `${languageInfo[lang].name}ç¿»è¯‘çŠ¶æ€å¼‚å¸¸`, 
                                passed: false 
                            });
                        }
                    }
                });
                
                // æ˜¾ç¤ºéªŒè¯ç»“æœ
                html += '<div class="verification-grid">';
                verifications.forEach(v => {
                    html += `<div class="verification-item ${v.passed ? 'pass' : 'fail'}">
                        ${v.passed ? 'âœ…' : 'âŒ'} ${v.test}
                    </div>`;
                });
                html += '</div>';
                
                // è®°å½•æµ‹è¯•ç»“æœ
                testResults.push({
                    step: stepNumber,
                    switch: `${fromLangInfo.name} â†’ ${toLangInfo.name}`,
                    passed: verifications.every(v => v.passed),
                    verifications: verifications
                });
                
                document.getElementById(resultId).innerHTML = html;
                
            } catch (error) {
                document.getElementById(`switch${stepNumber}-result`).innerHTML = 
                    `<div class="result error">âŒ åˆ‡æ¢å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æœ€ç»ˆéªŒè¯
        window.performFinalVerification = function() {
            try {
                let html = '<h3>ğŸ” æœ€ç»ˆéªŒè¯ç»“æœ</h3>';
                
                const allPassed = testResults.every(r => r.passed);
                
                if (allPassed) {
                    html += '<div class="result success">ğŸ‰ <strong>æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼åŒå‘è¿ç§»åŠŸèƒ½å®Œå…¨æ­£å¸¸</strong></div>';
                } else {
                    html += '<div class="result error">âŒ <strong>éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥</strong></div>';
                }
                
                // è¯¦ç»†ç»“æœ
                html += '<h4>è¯¦ç»†æµ‹è¯•ç»“æœï¼š</h4>';
                testResults.forEach(result => {
                    html += `<div class="result ${result.passed ? 'success' : 'error'}">`;
                    html += `<strong>æ­¥éª¤ ${result.step}: ${result.switch}</strong> - ${result.passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`;
                    html += '</div>';
                });
                
                // æœ€ç»ˆçŠ¶æ€éªŒè¯
                html += '<h4>æœ€ç»ˆçŠ¶æ€éªŒè¯ï¼š</h4>';
                
                const finalChecks = [
                    {
                        name: 'æ¯è¯­è®¾ç½®æ­£ç¡®',
                        check: userSettings.nativeLanguage === 'zh',
                        expected: 'ä¸­æ–‡',
                        actual: languageInfo[userSettings.nativeLanguage]?.name
                    },
                    {
                        name: 'æ¯è¯­æ³¨é‡Šæ­£ç¡®',
                        check: testWord.nativeNote === 'çº¢è‰²çš„æ°´æœ',
                        expected: 'çº¢è‰²çš„æ°´æœ',
                        actual: testWord.nativeNote
                    },
                    {
                        name: 'è‹±è¯­ç¿»è¯‘ä¿ç•™',
                        check: testWord.translations.some(t => t.language === 'en' && t.text === 'apple'),
                        expected: 'apple',
                        actual: testWord.translations.find(t => t.language === 'en')?.text || 'æ— '
                    },
                    {
                        name: 'éŸ©è¯­ç¿»è¯‘ä¿ç•™',
                        check: testWord.translations.some(t => t.language === 'ko' && t.text === 'ì‚¬ê³¼'),
                        expected: 'ì‚¬ê³¼',
                        actual: testWord.translations.find(t => t.language === 'ko')?.text || 'æ— '
                    }
                ];
                
                html += '<div class="verification-grid">';
                finalChecks.forEach(check => {
                    html += `<div class="verification-item ${check.check ? 'pass' : 'fail'}">
                        ${check.check ? 'âœ…' : 'âŒ'} ${check.name}<br>
                        <small>æœŸæœ›: ${check.expected} | å®é™…: ${check.actual}</small>
                    </div>`;
                });
                html += '</div>';
                
                const finalPassed = finalChecks.every(c => c.check);
                
                if (finalPassed && allPassed) {
                    html += '<div class="result success"><strong>ğŸš€ åŒå‘è¿ç§»ä¿®å¤å®Œå…¨æˆåŠŸï¼ç”¨æˆ·åé¦ˆçš„é—®é¢˜å·²å½»åº•è§£å†³ï¼</strong></div>';
                } else {
                    html += '<div class="result error"><strong>âš ï¸ ä»å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•</strong></div>';
                }
                
                document.getElementById('final-result').innerHTML = html;
                
            } catch (error) {
                document.getElementById('final-result').innerHTML = 
                    `<div class="result error">âŒ éªŒè¯å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ¸…ç†æµ‹è¯•
        window.cleanupTest = function() {
            try {
                // ç§»é™¤æµ‹è¯•å•è¯
                const testIndex = words.findIndex(w => w.id === 'bidirectional-test-word');
                if (testIndex >= 0) {
                    words.splice(testIndex, 1);
                    saveWordsToStorage();
                }
                
                // æ¢å¤åŸå§‹è®¾ç½®
                if (originalSettings) {
                    userSettings.nativeLanguage = originalSettings.nativeLanguage;
                    userSettings.learningLanguages = [...originalSettings.learningLanguages];
                }
                
                // æ¸…ç©ºç»“æœ
                testResults = [];
                
                document.getElementById('cleanup-result').innerHTML = 
                    '<div class="result success">âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†ï¼Œè®¾ç½®å·²æ¢å¤</div>';
                
                // æ¸…ç©ºæ‰€æœ‰ç»“æœæ˜¾ç¤º
                ['init-result', 'switch1-result', 'switch2-result', 'switch3-result', 'final-result'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
                
            } catch (error) {
                document.getElementById('cleanup-result').innerHTML = 
                    `<div class="result error">âŒ æ¸…ç†å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ˜¾ç¤ºå•è¯çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
        function displayWordState(title, word, settings) {
            const nativeLang = languageInfo[settings.nativeLanguage];
            
            let html = `<div class="word-state">`;
            html += `<h4>${title}</h4>`;
            html += `<p><strong>å½“å‰æ¯è¯­:</strong> ${nativeLang ? `${nativeLang.flag} ${nativeLang.name}` : 'æœªè®¾ç½®'}</p>`;
            html += `<p><strong>å­¦ä¹ è¯­è¨€:</strong> ${settings.learningLanguages.map(code => languageInfo[code]?.name).join(', ')}</p>`;
            
            html += `<div class="native-note">æ¯è¯­æ³¨é‡Š: ${word.nativeNote || 'æ— '}</div>`;
            
            html += '<p><strong>ç¿»è¯‘:</strong></p>';
            if (word.translations.length > 0) {
                word.translations.forEach(t => {
                    const lang = languageInfo[t.language];
                    html += `<span class="translation">${lang?.flag} ${lang?.name}: ${t.text}</span>`;
                });
            } else {
                html += '<span style="color: #666;">æ— ç¿»è¯‘</span>';
            }
            
            html += '</div>';
            
            return html;
        }
    </script>
</body>
</html>